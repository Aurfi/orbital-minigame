(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class rt{constructor(){this.fixedTimestep=1/60,this.maxSubsteps=10,this.accumulator=0}update(t,e){const s=Math.min(t,.25);this.accumulator+=s;let i=0;for(;this.accumulator>=this.fixedTimestep&&i<this.maxSubsteps;)e(this.fixedTimestep),this.accumulator-=this.fixedTimestep,i++;i>=this.maxSubsteps&&(this.accumulator=0)}static integrateMotion(t,e,s,i){const o=e.clone();e.x+=s.x*i,e.y+=s.y*i;const n=o.add(e).multiply(.5);t.x+=n.x*i,t.y+=n.y*i}static integrateVerlet(t,e,s,i,o){const n=o*o;t.x+=e.x*o+.5*s.x*n,t.y+=e.y*o+.5*s.y*n,e.x+=.5*(i.x+s.x)*o,e.y+=.5*(i.y+s.y)*o}static isStable(t,e,s){return t.magnitude()<5e4&&e.magnitude()<1e3&&s>0&&s<1}static getRecommendedTimestep(t,e){const s=.016666666666666666,i=t.magnitude(),o=e.magnitude();return i>1e4||o>100?s*.5:s}}class p{constructor(t=0,e=0){this.x=t,this.y=e}static zero(){return new p(0,0)}static one(){return new p(1,1)}static up(){return new p(0,1)}static right(){return new p(1,0)}static fromAngle(t,e=1){return new p(Math.cos(t)*e,Math.sin(t)*e)}add(t){return new p(this.x+t.x,this.y+t.y)}subtract(t){return new p(this.x-t.x,this.y-t.y)}multiply(t){return new p(this.x*t,this.y*t)}divide(t){return new p(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}magnitudeSquared(){return this.x*this.x+this.y*this.y}normalized(){const t=this.magnitude();return t>0?this.divide(t):p.zero()}angle(){return Math.atan2(this.y,this.x)}distanceTo(t){return this.subtract(t).magnitude()}distanceSquaredTo(t){return this.subtract(t).magnitudeSquared()}angleTo(t){const e=this.dot(t),s=this.magnitude(),i=t.magnitude();if(s===0||i===0)return 0;const o=e/(s*i);return Math.acos(Math.max(-1,Math.min(1,o)))}equals(t,e=1e-10){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e}set(t,e){return this.x=t,this.y=e,this}copy(t){return this.x=t.x,this.y=t.y,this}clone(){return new p(this.x,this.y)}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}}class qt{constructor(){this.buildings=[],this.buildingDefs=[],this.buildingSprites=[],this.treeDefs=[],this.treeSprites=[],this.spritesReady=!1,this.padBaseAngle=null,this.initializeBackground()}update(t,e){if(this.padBaseAngle===null){const s=Math.atan2(t.rocket.position.y,t.rocket.position.x),i=t.world.earthRotationRate||0;this.padBaseAngle=s-i*t.currentTime}}initializeBackground(){this.createLaunchFacilities(),this.createTrees(),this.prepareSprites()}prepareSprites(){this.buildingSprites=[];for(const t of this.buildingDefs){const e=document.createElement("canvas"),s=2;e.width=Math.max(2,Math.floor(t.width*s)),e.height=Math.max(2,Math.floor(t.height*s));const i=e.getContext("2d");if(!i){this.spritesReady=!1;return}i.fillStyle=t.color,i.fillRect(0,0,e.width,e.height),i.lineWidth=2,i.strokeStyle="#556",i.strokeRect(.5,.5,e.width-1,e.height-1),this.drawBuildingDetailsToCtx(i,t.width,t.height,t.type,s),this.buildingSprites.push({image:e,offset:t.offset,width:t.width,height:t.height})}this.spritesReady=!0}createTrees(){this.treeDefs=[];const t=()=>Math.random(),e=[220,320,450,620,800,1e3];for(const s of e){const i=6+Math.floor(t()*6);for(let o=0;o<i;o++){const n=t()<.5?-1:1,a=(t()-.5)*60,r=n*(s+a);if(Math.abs(r)<180)continue;const l=t()<.6?"pine":"broadleaf",c=l==="pine"?30+t()*18:22+t()*14,h=l==="pine"?c*.35:c*.6;this.treeDefs.push({offset:r,height:c,width:h,type:l})}}this.treeSprites=this.treeDefs.map(s=>{const o=Math.max(4,Math.floor(s.width*2)),n=Math.max(6,Math.floor(s.height*2)),a=document.createElement("canvas");a.width=o,a.height=n;const r=a.getContext("2d");return r?(r.clearRect(0,0,o,n),s.type==="pine"?(r.fillStyle="#6d4c41",r.fillRect(o/2-Math.max(2,Math.floor(o*.06)),n*.75,Math.max(4,o*.12),n*.25),r.fillStyle="#2e7d32",r.beginPath(),r.moveTo(o/2,0),r.lineTo(o*.1,n*.8),r.lineTo(o*.9,n*.8),r.closePath(),r.fill()):(r.fillStyle="#6d4c41",r.fillRect(o/2-Math.max(2,Math.floor(o*.06)),n*.7,Math.max(4,o*.12),n*.3),r.fillStyle="#388e3c",r.beginPath(),r.ellipse(o/2,n*.55,o*.45,n*.35,0,0,Math.PI*2),r.fill()),{image:a,offset:s.offset,width:s.width,height:s.height}):{image:a,offset:s.offset,width:s.width,height:s.height}})}drawBuildingDetailsToCtx(t,e,s,i,o){const n=a=>a*o;switch(i){case"skyscraper":{t.fillStyle="#c9dcf8";const a=n(e*.22),r=n(e*.18),l=n(e-e*.18-e*.22);t.fillRect(r,0,a,n(s)),t.fillRect(l,0,a,n(s)),t.strokeStyle="#9aa7b7",t.lineWidth=3,t.beginPath(),t.moveTo(n(e/2),n(s)),t.lineTo(n(e/2),n(s)+n(s*.12)),t.stroke();break}case"mid":{const a=Math.max(4,Math.floor(e/26)),r=Math.max(3,Math.floor(s/32)),l=n(8),c=n(16),h=(n(e)-a*l)/(a+1),u=(n(s)-r*c)/(r+1),d=h,y=u;t.fillStyle="#96b6ff";for(let m=0;m<r;m++)for(let f=0;f<a;f++){const b=d+f*(l+h),S=y+m*(c+u);t.fillRect(b,S,l,c)}break}case"low":{const a=Math.max(3,Math.floor(e/50)),r=n(16),l=n(10),c=n(12),h=a*r+(a-1)*c;let u=(n(e)-h)/2;const d=n(s)/2-l/2;t.fillStyle="#9aa7b7";for(let y=0;y<a;y++)t.fillRect(u,d,r,l),u+=r+c;break}case"box":{const a=Math.max(3,Math.floor(e/50)),r=n(10),l=n(14),c=(n(e)-a*r)/(a+1),h=c,u=n(s)/2-l/2;t.fillStyle="#9fc3ff";for(let d=0;d<a;d++){const y=h+d*(r+c);t.fillRect(y,u,r,l)}break}}}createLaunchFacilities(){const t=(e,s,i,o,n)=>{Math.abs(e)<160||this.buildingDefs.push({offset:e,width:s,height:i,type:o,color:n})};t(-350,100,360,"skyscraper","#8fb7e9"),t(-540,220,220,"mid","#e9eef6"),t(-240,160,70,"low","#bdbdbd"),t(260,260,200,"mid","#f2f5fa"),t(430,200,230,"mid","#79a3e6"),t(560,160,90,"low","#cfd8dc"),t(320,180,90,"box","#cfd8dc")}render(t,e){if(!e||!e.rocket)return;e.world.getAltitude(e.rocket.position.magnitude())<2e4&&this.renderBuildings(t,e)}renderBuildings(t,e){const s=e.world.planetRadius,i=e.world.earthRotationRate||0,o=(this.padBaseAngle??0)+i*e.currentTime,n=new p(Math.cos(o),Math.sin(o)),a=new p(-Math.sin(o),Math.cos(o)),r=n.multiply(s+1);if(this.spritesReady){for(const l of this.buildingSprites){if(Math.abs(l.offset)<160)continue;const c=r.add(a.multiply(l.offset)).add(n.multiply(l.height/2));t.drawSprite(l.image,c,l.width,l.height)}for(const l of this.treeSprites){if(Math.abs(l.offset)<160)continue;const c=r.add(a.multiply(l.offset)).add(n.multiply(l.height/2));t.drawSprite(l.image,c,l.width,l.height)}}else{for(const l of this.buildingDefs){if(Math.abs(l.offset)<160)continue;const c=r.add(a.multiply(l.offset)).add(n.multiply(l.height/2)),h=new p(c.x-l.width/2,c.y-l.height/2);t.drawRectangle(h,l.width,l.height,l.color,"#556",2);const u={position:new p(h.x+l.width/2,h.y),width:l.width,height:l.height,type:l.type,color:l.color};this.addBuildingDetails(t,u)}for(const l of this.treeDefs){if(Math.abs(l.offset)<160)continue;const c=r.add(a.multiply(l.offset)).add(n.multiply(l.height/2));l.type==="pine"?(t.drawRectangle(new p(c.x-l.width*.05,c.y+l.height*.25),l.width*.1,l.height*.25,"#6d4c41"),t.drawRotated(c,0,()=>{const h=new p(0,l.height*.5),u=new p(-l.width*.45,-l.height*.3),d=new p(l.width*.45,-l.height*.3);t.drawLine(c.add(h),c.add(u),"#2e7d32",3),t.drawLine(c.add(h),c.add(d),"#2e7d32",3),t.drawLine(c.add(u),c.add(d),"#2e7d32",3)})):(t.drawRectangle(new p(c.x-l.width*.05,c.y+l.height*.2),l.width*.1,l.height*.3,"#6d4c41"),t.drawCircle(c,Math.max(3,l.width*.4),"#388e3c"))}}}addBuildingDetails(t,e){const s=e.position;switch(e.type){case"skyscraper":{const i=e.width*.22,o=s.x-e.width/2+e.width*.18,n=s.x+e.width/2-e.width*.18-i,a="#c9dcf8";t.drawRectangle(new p(o,s.y),i,e.height,a),t.drawRectangle(new p(n,s.y),i,e.height,a);const r=new p(s.x,s.y+e.height);t.drawLine(new p(r.x,r.y),new p(r.x,r.y+e.height*.12),"#9aa7b7",3);break}case"mid":{const i=Math.max(4,Math.floor(e.width/26)),o=Math.max(3,Math.floor(e.height/32)),n=8,a=16,r=(e.width-i*n)/(i+1),l=(e.height-o*a)/(o+1),c=s.x-e.width/2+r,h=s.y+l;for(let u=0;u<o;u++)for(let d=0;d<i;d++){const y=c+d*(n+r),m=h+u*(a+l);t.drawRectangle(new p(y,m),n,a,"#96b6ff")}break}case"low":{const i=Math.max(3,Math.floor(e.width/50)),o=16,n=10,a=12,r=i*o+(i-1)*a;let l=s.x-r/2;const c=s.y+e.height/2-n/2;for(let h=0;h<i;h++)t.drawRectangle(new p(l,c),o,n,"#9aa7b7"),l+=o+a;break}case"box":{const i=Math.max(3,Math.floor(e.width/50)),o=10,n=14,a=(e.width-i*o)/(i+1),r=s.x-e.width/2+a,l=s.y+e.height/2-n/2;for(let c=0;c<i;c++){const h=r+c*(o+a);t.drawRectangle(new p(h,l),o,n,"#9fc3ff")}break}}}}class Xt{constructor(t){this.camera=null,this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D rendering context");this.context=e,this.pixelRatio=window.devicePixelRatio||1,this.setupCanvas()}setupCanvas(){const t=this.canvas.getBoundingClientRect();this.pixelRatio=window.devicePixelRatio||1;const e=Math.max(1,Math.floor(t.width*this.pixelRatio)),s=Math.max(1,Math.floor(t.height*this.pixelRatio));this.canvas.width!==e&&(this.canvas.width=e),this.canvas.height!==s&&(this.canvas.height=s),this.context.setTransform(1,0,0,1,0,0),this.context.scale(this.pixelRatio,this.pixelRatio),this.canvas.style.width=`${t.width}px`,this.canvas.style.height=`${t.height}px`}refreshDprIfNeeded(){const t=window.devicePixelRatio||1;Math.abs(t-this.pixelRatio)>.001&&(this.pixelRatio=t,this.setupCanvas())}setCamera(t){this.camera=t}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}beginFrame(){if(this.refreshDprIfNeeded(),this.context.save(),this.camera){const t=this.canvas.width/(2*this.pixelRatio),e=this.canvas.height/(2*this.pixelRatio);this.context.translate(t,e),this.context.scale(this.camera.zoom,-this.camera.zoom);const s=this.camera.rotation||0;s!==0&&this.context.rotate(-s),this.context.translate(-this.camera.position.x,-this.camera.position.y)}}endFrame(){this.context.restore()}drawCircle(t,e,s,i,o=1){this.context.beginPath(),this.context.arc(t.x,t.y,e,0,2*Math.PI),s&&(this.context.fillStyle=s,this.context.fill()),i&&(this.context.strokeStyle=i,this.context.lineWidth=o,this.context.stroke())}drawRectangle(t,e,s,i,o,n=1){i&&(this.context.fillStyle=i,this.context.fillRect(t.x,t.y,e,s)),o&&(this.context.strokeStyle=o,this.context.lineWidth=n,this.context.strokeRect(t.x,t.y,e,s))}drawLine(t,e,s,i=1){this.context.beginPath(),this.context.moveTo(t.x,t.y),this.context.lineTo(e.x,e.y),this.context.strokeStyle=s,this.context.lineWidth=i,this.context.stroke()}drawText(t,e,s="#ffffff",i="16px monospace",o="left"){this.context.fillStyle=s,this.context.font=i,this.context.textAlign=o,this.context.fillText(t,e.x,e.y)}drawRotated(t,e,s){this.context.save(),this.context.translate(t.x,t.y),this.context.rotate(e),s(),this.context.restore()}drawSprite(t,e,s,i,o=0,n=1,a=1){const r=s??t.width,l=i??t.height;this.context.save(),this.context.imageSmoothingEnabled=!0,this.context.imageSmoothingQuality="high",this.context.translate(e.x,e.y),o!==0&&this.context.rotate(o),(n!==1||a!==1)&&this.context.scale(n,a),this.context.scale(1,-1),this.context.drawImage(t,-r/2,-l/2,r,l),this.context.restore()}worldToScreen(t){if(!this.camera)return t.clone();const e=this.canvas.width/(2*this.pixelRatio),s=this.canvas.height/(2*this.pixelRatio),i=t.subtract(this.camera.position),o=e+i.x*this.camera.zoom,n=s-i.y*this.camera.zoom;return new p(o,n)}fillRadialGradientWorld(t,e,s,i,o){const n=this.context,a=this.worldToScreen(t),r=this.camera?this.camera.zoom:1,l=Math.max(0,e*r),c=Math.max(l+1,s*r);n.save(),n.setTransform(1,0,0,1,0,0);const h=n.createRadialGradient(a.x,a.y,l,a.x,a.y,c);h.addColorStop(0,i),h.addColorStop(1,o),n.fillStyle=h;const u=this.canvas.width/this.pixelRatio,d=this.canvas.height/this.pixelRatio;n.fillRect(0,0,u,d),n.restore()}screenToWorld(t){if(!this.camera)return t.clone();const e=this.canvas.width/(2*this.pixelRatio),s=this.canvas.height/(2*this.pixelRatio),i=(t.x-e)/this.camera.zoom,o=-(t.y-s)/this.camera.zoom;return this.camera.position.add(new p(i,o))}handleResize(){this.setupCanvas()}getSize(){return new p(this.canvas.width/this.pixelRatio,this.canvas.height/this.pixelRatio)}getContext2D(){return this.context}}class Ut{constructor(t=p.zero(),e=1){this.target=null,this.rotation=0,this.followSpeed=2,this.zoomSpeed=1,this.position=t.clone(),this.zoom=e}update(t){if(this.target){const e=this.target.subtract(this.position),s=e.magnitude();if(s>1){const i=this.followSpeed*t,o=e.normalized().multiply(Math.min(i*s,s));this.position=this.position.add(o)}}}setTarget(t){this.target=t?.clone()||null}setZoom(t){this.zoom=Math.max(7e-4,Math.min(2,t))}move(t){this.position=this.position.add(t)}setPosition(t){this.position=t.clone()}setRotation(t){this.rotation=t}}class jt{constructor(){this.cloudTextures=new Map,this.cloudLayers=[],this.generateCloudTextures(),this.initializeLayers()}generateCloudTextures(){this.cloudTextures.set("cumulus",this.createCumulusTexture(256))}createCumulusTexture(t){const e=document.createElement("canvas");e.width=t,e.height=t;const s=e.getContext("2d");if(!s)return e;s.clearRect(0,0,t,t);const i=3+Math.random()*2;for(let o=0;o<i;o++){const n=t*(.2+Math.random()*.6),a=t*(.3+Math.random()*.4),r=t*(.15+Math.random()*.1),l=s.createRadialGradient(n,a,0,n,a,r);l.addColorStop(0,"rgba(255, 255, 255, 0.9)"),l.addColorStop(.4,"rgba(255, 255, 255, 0.7)"),l.addColorStop(.8,"rgba(240, 245, 250, 0.4)"),l.addColorStop(1,"rgba(240, 245, 250, 0)"),s.fillStyle=l,s.beginPath(),s.arc(n,a,r,0,Math.PI*2),s.fill();for(let c=0;c<4;c++){const h=c/4*Math.PI*2,u=n+Math.cos(h)*r*.6,d=a+Math.sin(h)*r*.5,y=r*(.4+Math.random()*.2),m=s.createRadialGradient(u,d,0,u,d,y);m.addColorStop(0,"rgba(255, 255, 255, 0.8)"),m.addColorStop(.6,"rgba(250, 252, 255, 0.5)"),m.addColorStop(1,"rgba(250, 252, 255, 0)"),s.fillStyle=m,s.beginPath(),s.arc(u,d,y,0,Math.PI*2),s.fill()}}return e}createStratusTexture(t){const e=document.createElement("canvas");e.width=t,e.height=t;const s=e.getContext("2d");if(!s)return e;s.clearRect(0,0,t,t);const i=2+Math.random()*2;for(let o=0;o<i;o++){const n=t*(.3+o*.15+Math.random()*.1),a=t*(.08+Math.random()*.04),r=s.createLinearGradient(0,n-a/2,0,n+a/2);r.addColorStop(0,"rgba(230, 235, 240, 0)"),r.addColorStop(.2,"rgba(230, 235, 240, 0.3)"),r.addColorStop(.5,"rgba(245, 248, 250, 0.5)"),r.addColorStop(.8,"rgba(230, 235, 240, 0.3)"),r.addColorStop(1,"rgba(230, 235, 240, 0)"),s.fillStyle=r,s.beginPath(),s.moveTo(0,n);for(let l=0;l<=t;l+=t/8){const c=Math.sin(l/t*Math.PI*4)*a*.3;s.lineTo(l,n+c)}s.lineTo(t,n+a),s.lineTo(0,n+a),s.closePath(),s.fill()}return e}createCirrusTexture(t){const e=document.createElement("canvas");e.width=t,e.height=t;const s=e.getContext("2d");if(!s)return e;s.clearRect(0,0,t,t);const i=4+Math.random()*3;for(let o=0;o<i;o++){s.save();const n=Math.random()*t,a=t*(.2+Math.random()*.6),r=t*(.3+Math.random()*.4),l=-Math.PI/6+Math.random()*Math.PI/3;s.translate(n,a),s.rotate(l);const c=s.createLinearGradient(0,0,r,0);c.addColorStop(0,"rgba(255, 255, 255, 0)"),c.addColorStop(.2,"rgba(255, 255, 255, 0.15)"),c.addColorStop(.5,"rgba(255, 255, 255, 0.25)"),c.addColorStop(.8,"rgba(255, 255, 255, 0.15)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),s.strokeStyle=c,s.lineWidth=2+Math.random()*3,s.lineCap="round",s.beginPath(),s.moveTo(0,0);const h=8;for(let u=1;u<=h;u++){const d=u/h*r,y=Math.sin(u/h*Math.PI*2)*(3+Math.random()*2);s.lineTo(d,y)}s.stroke(),s.restore()}return e}initializeLayers(){this.cloudLayers.push({altitude:3e3,rotationSpeed:1e-5,clouds:this.generateCloudPositions("cumulus",6,.8)}),this.cloudLayers.push({altitude:5e3,rotationSpeed:8e-6,clouds:this.generateCloudPositions("cumulus",4,.6)})}generateCloudPositions(t,e,s){const i=[],o=Math.PI/2,n=Math.PI/3;for(let a=0;a<e;a++){let r=a/e*Math.PI*2;Math.abs(r-o)<n&&(r<o?r=o-n:r=o+n);const l=(Math.random()-.5)*(Math.PI*2/e)*.5;let c=r+l;Math.abs(c-o)<n*.8&&(c=c<o?o-n:o+n),i.push({type:t,angle:c,latitudeOffset:0,scale:1.2+Math.random()*.6,opacity:.7+Math.random()*.2})}return i}render(t,e,s,i,o){t.save();for(const n of this.cloudLayers){const a=s+n.altitude/6371e3*s,r=o+n.rotationSpeed*i;for(const l of n.clouds){const c=l.angle+r,h=e.x+Math.cos(c)*a,u=e.y+Math.sin(c)*a,d=this.cloudTextures.get(l.type);if(!d)continue;const y=s*.25*l.scale;t.globalAlpha=l.opacity*.8,t.drawImage(d,h-y/2,u-y/2,y,y)}}t.restore()}}function _t(g,t){const e=(i,o="#2f7f3a")=>{g.fillStyle=o,g.beginPath(),i(),g.fill()};e(()=>{g.moveTo(-.55*t,.1*t),g.bezierCurveTo(-.7*t,.35*t,-.42*t,.5*t,-.3*t,.32*t),g.bezierCurveTo(-.28*t,.18*t,-.26*t,.05*t,-.24*t,-.03*t),g.bezierCurveTo(-.27*t,-.2*t,-.38*t,-.28*t,-.52*t,-.36*t),g.bezierCurveTo(-.62*t,-.22*t,-.63*t,-.04*t,-.55*t,.1*t)}),e(()=>{g.moveTo(.2*t,.2*t),g.bezierCurveTo(.36*t,.26*t,.42*t,.1*t,.34*t,-.02*t),g.bezierCurveTo(.28*t,-.1*t,.22*t,-.1*t,.16*t,-.12*t),g.bezierCurveTo(.1*t,-.06*t,.06*t,.06*t,.08*t,.16*t),g.bezierCurveTo(.12*t,.24*t,.16*t,.24*t,.2*t,.2*t)}),e(()=>{g.moveTo(.34*t,-.02*t),g.bezierCurveTo(.5*t,.04*t,.54*t,.16*t,.46*t,.28*t),g.bezierCurveTo(.38*t,.34*t,.3*t,.3*t,.24*t,.26*t),g.bezierCurveTo(.32*t,.18*t,.34*t,.1*t,.34*t,-.02*t)}),e(()=>{g.moveTo(-.12*t,.5*t),g.bezierCurveTo(-.02*t,.56*t,.05*t,.48*t,.02*t,.4*t),g.bezierCurveTo(-.04*t,.38*t,-.08*t,.4*t,-.12*t,.5*t)},"#2e7f3a");const s=[[-.36,.16,.06,.04],[-.3,.06,.04,.03],[.18,.05,.05,.03]];g.fillStyle="#2f7f3a";for(const[i,o,n,a]of s)g.beginPath(),g.ellipse(i*t,o*t,n*t,a*t,0,0,Math.PI*2),g.fill()}const Mt=new Map;function kt(g){const t=Math.max(32,Math.floor(g)),e=Mt.get(t);if(e)return e;const s=document.createElement("canvas");s.width=t,s.height=t;const i=s.getContext("2d");if(!i)return s;i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high";const o=t/2;i.fillStyle="#0b3766",i.beginPath(),i.arc(o,o,o,0,Math.PI*2),i.fill(),i.save(),i.beginPath(),i.arc(o,o,o,0,Math.PI*2),i.clip(),i.translate(o,o),i.save(),i.scale(1,.82),i.translate(0,o*.18),_t(i,o),i.restore(),i.fillStyle="#2f7f3a",i.beginPath();const n=o,a=0;i.moveTo(n,a-o*.25),i.lineTo(n,a+o*.25),i.bezierCurveTo(n-o*.1,a+o*.3,n-o*.2,a+o*.35,n-o*.35,a+o*.3),i.bezierCurveTo(n-o*.45,a+o*.25,n-o*.5,a+o*.15,n-o*.48,a+o*.08),i.lineTo(n-o*.48,a-o*.08),i.bezierCurveTo(n-o*.5,a-o*.15,n-o*.45,a-o*.25,n-o*.35,a-o*.3),i.bezierCurveTo(n-o*.2,a-o*.35,n-o*.1,a-o*.3,n,a-o*.25),i.closePath(),i.fill();const r=o*.34;i.fillStyle="#e8f4ff",i.beginPath(),i.arc(0,0,r,0,Math.PI*2),i.fill(),i.fillStyle="#f0f8ff",i.beginPath(),i.arc(0,0,r*.7,0,Math.PI*2),i.fill(),i.fillStyle="#f8fcff",i.beginPath(),i.arc(0,0,r*.4,0,Math.PI*2),i.fill(),i.fillStyle="#e8f4ff";for(let h=0;h<8;h++){const u=h/8*Math.PI*2,d=.9+Math.sin(h*1.7)*.15,y=r*.15*d,m=Math.cos(u)*r*.85,f=Math.sin(u)*r*.85;i.beginPath(),i.arc(m,f,y,0,Math.PI*2),i.fill()}const l=o*.03,c=i.createRadialGradient(0,0,o-l,0,0,o);return c.addColorStop(0,"rgba(0, 0, 0, 0)"),c.addColorStop(.7,"rgba(0, 0, 0, 0)"),c.addColorStop(1,"rgba(135, 206, 235, 0.15)"),i.fillStyle=c,i.beginPath(),i.arc(0,0,o,0,Math.PI*2),i.fill(),i.restore(),Mt.set(t,s),s}class Kt{constructor(){this.cloudSystem=new jt,this.initializePlanetTexture()}initializePlanetTexture(){try{this.planetTexture=kt(2048)}catch(t){console.warn("Failed to generate planet texture:",t)}}render(t,e,s,i,o){const n=p.zero(),a=e.planetRadius,r=e.getAltitude(i.magnitude());this.drawSkyGradient(t,r),this.drawPlanetTexture(t,n,a,e,s,o),this.drawClouds(t,n,a,e,s,o),this.drawAtmosphere(t,n,a,r)}drawSkyGradient(t,e){const s=t.getContext2D();if(!s)return;const i=s.canvas.width,o=s.canvas.height,n=s.canvas.clientWidth||i,a=s.canvas.clientHeight||o;if(n<480||a<380||e>=2e5)return;const c=Math.min(1,e/175e3),h=Math.round(135*(1-c)),u=Math.round(206*(1-c)),d=Math.round(235*(1-c)),y=s.createLinearGradient(0,0,0,o),m=`rgb(${Math.round(h*.15)}, ${Math.round(u*.15)}, ${Math.round(d*.15)})`,f=`rgb(${h}, ${u}, ${d})`;y.addColorStop(0,m),y.addColorStop(1,f),s.save(),s.fillStyle=y,s.fillRect(0,0,i,o),s.restore()}drawPlanetTexture(t,e,s,i,o,n){const a=i.earthRotationRate||0,r=n+a*o;if(this.planetTexture){const l=t.getContext2D();l.save(),l.beginPath(),l.arc(e.x,e.y,s,0,Math.PI*2),l.clip(),t.drawSprite(this.planetTexture,e,s*2,s*2,r),l.restore()}else t.drawCircle(e,s,"#0b3766","#2d3a16",2)}drawClouds(t,e,s,i,o,n){const a=i.earthRotationRate||0,r=n+a*o,l=t.getContext2D();this.cloudSystem.render(l,{x:e.x,y:e.y},s,o,r)}drawAtmosphere(t,e,s,i){if(i>1e5)return;const o=Math.max(0,1-i/1e5),n=[{radius:s*1.02,alpha:.03*o},{radius:s*1.04,alpha:.02*o},{radius:s*1.06,alpha:.015*o},{radius:s*1.08,alpha:.01*o}],a=t.getContext2D();a.save();for(const r of n){const l=a.createRadialGradient(e.x,e.y,s,e.x,e.y,r.radius);l.addColorStop(0,"rgba(135, 206, 235, 0)"),l.addColorStop(.7,`rgba(135, 206, 235, ${r.alpha*.5})`),l.addColorStop(1,`rgba(135, 206, 235, ${r.alpha})`),a.fillStyle=l,a.beginPath(),a.arc(e.x,e.y,r.radius,0,Math.PI*2),a.fill()}a.restore()}}class Zt{constructor(t){this.spriteFull=null,this.spriteUpper=null,this.spritesLoaded=!1,this.config={stage1Width:50,stage1Height:130,stage2Width:35,stage2Height:70,payloadWidth:25,payloadHeight:35,stage1Color:"#f0f0f0",stage1AccentColor:"#2c5aa0",stage2Color:"#ffffff",stage2AccentColor:"#c0392b",payloadColor:"#e67e22",payloadAccentColor:"#d35400",exhaustColor:"#ff4500",exhaustCoreColor:"#ffff00",exhaustLength:25,exhaustWidth:12,windowColor:"#4169e1",finColor:"#2c3e50",fuelIndicatorBorder:"#34495e",...t};try{const e=(o,n)=>{const a=r=>{if(r>=o.length)return;const l=new Image;l.crossOrigin="anonymous",l.onload=()=>{n(l),this.spritesLoaded=!0},l.onerror=()=>a(r+1),l.src=o[r]};a(0)},s=import.meta,i=o=>s.env?.BASE_URL?`${s.env.BASE_URL.replace(/\/+$/,"/")}${o.replace(/^\/+/,"")}`:`/${o.replace(/^\/+/,"")}`;e([i("assets/rocket_full.png"),i("assets/rocket_full.jpg"),i("assets/rocket_full.jpeg"),i("assets/rocket_full.webp")],o=>{this.spriteFull=o}),e([i("assets/upper_stage.png"),i("assets/upper_stage.jpg"),i("assets/upper_stage.jpeg"),i("assets/upper_stage.webp")],o=>{this.spriteUpper=o})}catch{}}render(t,e){const s=e.position,i=e.visualRotation??e.rotation,o=e.isEngineIgnited,n=e.throttle,r=-this.getRocketBounds(e).height/2;t.drawRotated(s,i,()=>{if(!!(this.spriteFull&&this.spriteUpper)){const m=this.spriteFull,f=this.spriteUpper,b=e.currentStage??0,S=b===0?10:14;e.exhaustY=r+S,o&&n>0&&this.drawExhaust(t,n,e);const M=b===0?m:f,x=this.getRocketBounds(e),v=x.width*1.15,A=x.height*1.15,C=x.width*1.35,w=x.height*.65,R=b===0?v:C,T=b===0?A:w,D=b===0?8:0;t.drawSprite(M,new p(0,r+x.height/2+D),R,T)}else this.drawRocketBody(t,e,r),o&&n>0&&this.drawExhaust(t,n,e);this.drawSeparatedStages(t,e)});const l=e.exhaustY??0,h=(e.currentStage??0)===0?6:4,u=l-h,d=new p(s.x+-Math.sin(i)*u,s.y+Math.cos(i)*u);e.engineWorldPos=d,e.engineDownDir=new p(Math.sin(i),-Math.cos(i))}drawRocketBody(t,e,s=0){let i=s;const o=e.stages||[],n=e.currentStage;let a=0;for(let h=n;h<o.length;h++){o[h];const u=h===n;let d,y,m;h===0?(d=this.config.stage1Width,y=this.config.stage1Height,m=this.config.stage1Color):h===1?(d=this.config.stage2Width,y=this.config.stage2Height,m=this.config.stage2Color):(d=this.config.payloadWidth,y=this.config.payloadHeight,m=this.config.payloadColor);const f=new p(-d/2,i);t.drawRectangle(f,d,y,m,"#000000",2),h===0?this.drawStage1Details(t,f,d,y):h===1&&this.drawStage2Details(t,f,d,y),u&&(a=i),i+=y}e.exhaustY=a;const r=new p(-this.config.payloadWidth/2,i);t.drawRectangle(r,this.config.payloadWidth,this.config.payloadHeight,this.config.payloadColor,"#000000",1);const l=4,c=new p(0,i+this.config.payloadHeight);this.drawTriangle(t,c,this.config.payloadWidth/2,l,this.config.payloadColor)}drawExhaust(t,e,s){const i=e,o=s.currentStage||0;let n=1;o===0?n=1.5:o===1?n=.45:n=.7;let a=this.config.exhaustLength*i*n,r=this.config.exhaustWidth*i*n;o===1&&(a*=.8,r*=.85),s.exhaustLength=a,s.exhaustWidth=r;const l=s.exhaustY||0,c=o===1?2:0,h=new p(-r/2+c,l-a);t.drawRectangle(h,r,a,this.config.exhaustColor);const u=r*.6,d=a*.8,y=new p(-u/2+c,l-d);t.drawRectangle(y,u,d,this.config.exhaustCoreColor),this.drawExhaustParticles(t,e,n,l)}drawExhaustParticles(t,e,s=1,i=0){const o=Math.floor(e*8*s);for(let n=0;n<o;n++){const a=(Math.random()-.5)*this.config.exhaustWidth*1.5*s,r=i-Math.random()*this.config.exhaustLength*1.2*s,l=(Math.random()*2+1)*s,c=new p(a,r),h=Math.random()*.8+.2,u=`rgba(255, ${Math.floor(100+Math.random()*155)}, 0, ${h})`;t.drawCircle(c,l,u)}}drawSeparatedStages(t,e){}renderDetachedStage(t,e,s,i,o=1){const n=Math.max(0,Math.min(1,o)),a=r=>{if(r.startsWith("#")){const l=r.replace("#",""),c=Number.parseInt(l.length===3?l.split("").map(y=>y+y).join(""):l,16),h=c>>16&255,u=c>>8&255,d=c&255;return`rgba(${h}, ${u}, ${d}, ${n})`}return r};t.drawRotated(s,i,()=>{let r=this.config.stage2Width,l=this.config.stage2Height,c=this.config.stage2Color;e===0&&(r=this.config.stage1Width,l=this.config.stage1Height,c=this.config.stage1Color);const h=new p(-r/2,-l/2);t.drawRectangle(h,r,l,a(c),"#000000",1),e===0?this.drawStage1Details(t,h,r,l):this.drawStage2Details(t,h,r,l)})}drawTriangle(t,e,s,i,o){const n=new p(e.x-s,e.y-i),a=new p(e.x+s,e.y-i);t.drawLine(e,n,o,2),t.drawLine(e,a,o,2),t.drawLine(n,a,o,2)}getRocketBounds(t){const e=t.stages||[],s=Math.max(0,Math.min(t.currentStage??0,e.length));let i=this.config.payloadHeight+4,o=this.config.payloadWidth;const n=!!(this.spriteFull&&this.spriteUpper),a=1.15,r=1.15,l=.65,c=1.35;for(let h=s;h<e.length;h++)h===0?(i+=n?this.config.stage1Height*a:this.config.stage1Height,o=Math.max(o,n?this.config.stage1Width*r:this.config.stage1Width)):h===1?(i+=n?this.config.stage2Height*l:this.config.stage2Height,o=Math.max(o,n?this.config.stage2Width*c:this.config.stage2Width)):(i+=this.config.payloadHeight,o=Math.max(o,this.config.payloadWidth));return{width:o,height:i}}drawStage1Details(t,e,s,i){const n=new p(e.x+5,e.y+10),a=new p(e.x+s-5-4,e.y+10);t.drawRectangle(n,4,i-20,this.config.stage1AccentColor),t.drawRectangle(a,4,i-20,this.config.stage1AccentColor);const r=8,l=6,c=new p(e.x+s*.25-r/2,e.y-l),h=new p(e.x+s*.75-r/2,e.y-l);t.drawRectangle(c,r,l,this.config.finColor),t.drawRectangle(h,r,l,this.config.finColor),this.drawFins(t,e,s,i)}drawStage2Details(t,e,s,i){const n=new p(e.x,e.y+i*.3);t.drawRectangle(n,s,8,this.config.stage2AccentColor);const a=4,r=new p(e.x+s*.3-a/2,e.y+i*.6),l=new p(e.x+s*.7-a/2,e.y+i*.6);t.drawCircle(r,a/2,this.config.windowColor),t.drawCircle(l,a/2,this.config.windowColor);const c=6,h=4,u=new p(e.x+s/2-c/2,e.y-h);t.drawRectangle(u,c,h,this.config.finColor)}drawFins(t,e,s,i){const a=new p(e.x-8,e.y+i-20-10);t.drawRectangle(a,8,20,this.config.finColor);const r=new p(e.x+s,e.y+i-20-10);t.drawRectangle(r,8,20,this.config.finColor)}updateConfig(t){this.config={...this.config,...t}}}class Qt{constructor(t){this.canvas=t,this.messages=[],this.lastLayer=-1}reset(){this.messages=[],this.lastLayer=-1}addMessage(t,e,s=3){this.messages.push({text:t,time:e,duration:s})}getMessages(){return[...this.messages]}checkLayers(t,e,s){const i=t.getAltitude(e);let o=-1;if(i<11e3?o=0:i<5e4?o=1:i<8e4?o=2:i<7e5?o=3:o=4,o>this.lastLayer&&o>=0){if(o===0&&i<1e3)return;const a=["You're in the Troposphere !","You reached the Stratosphere!","You reached the Mesosphere!","You reached the Thermosphere!","You reached the Exosphere! (Near-space)"][o]??"";a&&this.addMessage(a,s,3),this.lastLayer=o}}update(t){for(let e=this.messages.length-1;e>=0;e--){const s=this.messages[e];t-s.time>s.duration&&this.messages.splice(e,1)}}render(t){const e=this.canvas.getContext("2d");if(!e||this.messages.length===0)return;e.save(),e.setTransform(1,0,0,1,0,0);const s=this.canvas.width/2;let i=90;for(const o of this.messages){const n=t-o.time,a=Math.min(1,n*3),r=Math.min(1,Math.max(0,(o.duration-n)*2)),l=a*r;e.font="14px monospace",e.textAlign="left";const c=Math.min(this.canvas.width*.6,380),h=this.wrapText(e,o.text,c),u=18;let d=0;for(const v of h)d=Math.max(d,e.measureText(v).width);const y=12,m=8,f=d+y*2,b=h.length*u+m*2,S=s-f/2,M=i;e.fillStyle=`rgba(0, 50, 100, ${l*.8})`,e.fillRect(S,M,f,b),e.strokeStyle=`rgba(100, 150, 255, ${l})`,e.lineWidth=2,e.strokeRect(S,M,f,b),e.fillStyle=`rgba(255, 255, 255, ${l})`;let x=M+m+13;for(const v of h)e.fillText(v,S+y,x),x+=u;i+=b+8}e.restore()}wrapText(t,e,s){const i=e.split(" "),o=[];let n="";for(const a of i){const r=n?`${n} ${a}`:a;t.measureText(r).width>s&&n?(o.push(n),n=a):n=r}return n&&o.push(n),o}}const vt=["A low Earth orbit (LEO) typically ranges from 160 km to 2,000 km above Earth.","The International Space Station orbits Earth between ~330 km and ~420 km, circling the planet about every 90 minutes.","SpaceXâ€™s Falcon 9 first stage can land propulsively for reuse â€” try staging and landing in-game!","The KÃ¡rmÃ¡n line, at 100 km altitude, is commonly used to define the edge of space.","Geostationary orbit sits about 35,786 km above Earthâ€™s equator â€” same speed and direction as Earthâ€™s rotation.","Satellites need about 7.8 km/s for a stable LEO around Earth; our tiny planet in-game needs much less.","The Apollo missions used Saturn V, still the most powerful rocket ever successfully flown.","Atmospheric density drops exponentially with altitude; most of the air is within ~20 km of the surface.","Orbital velocity decreases with altitude because gravity weakens with distance.","A Hohmann transfer is one of the most efficient ways to move between circular orbits.","Gravity turns reduce steering losses by letting thrust and gravity bend the trajectory naturally.","Thrust-to-weight ratio (TWR) > 1 is needed to lift off; higher TWR means faster climb but more drag losses.","Pitching east on launch takes advantage of Earthâ€™s rotation, saving a bit of deltaâ€‘V.","Circularization burns are done at apoapsis (to raise periapsis) or at periapsis (to raise apoapsis).","Deltaâ€‘V is a budget of how much you can change your velocity; staging increases deltaâ€‘V by shedding dry mass.","Prograde burns raise the opposite side of your orbit; retrograde burns lower it.","Inclination changes are cheapest at high altitude where orbital velocity is lower.","Reentry heating scales strongly with speed and density â€” lower and slower helps.","In vacuum, thrust doesnâ€™t need air to push against; it pushes against the exhaust mass itself (Newtonâ€™s third law).","Twoâ€‘body orbits are conic sections: circles, ellipses, parabolas, and hyperbolas.","Small course corrections early can save a lot of fuel compared to large late corrections.","A retrograde burn at periapsis lowers apoapsis most efficiently (and vice versa).","Docking requires matching not just position, but also velocity (and often plane/inclination)."];class Jt{constructor(t){this.bubbles=[],this.shownFacts=new Set,this.lastSpawnMs=0,this.nextIntervalSec=35,this.canvas=t,this.loadShownFacts()}update(t,e){const s=typeof window<"u"&&(window.devicePixelRatio||1)||1,i=this.canvas.clientWidth||Math.round(this.canvas.width/s);if(!(typeof window<"u"&&window.matchMedia?.("(pointer: coarse)").matches||i<1e3)&&!(e<5e3)){if((t-this.lastSpawnMs)/1e3>=this.nextIntervalSec){const n=this.pickNextFactIndex();if(n!==null){const a=vt[n];this.shownFacts.add(n),this.saveShownFacts();const r=Math.round(this.canvas.width/2),l=60;this.bubbles.push({text:a,pos:new p(r,l),bornAtMs:t,ttlSec:12+Math.random()*4,opacity:0}),this.lastSpawnMs=t,this.nextIntervalSec=20+Math.random()*25}}for(let n=this.bubbles.length-1;n>=0;n--){const a=this.bubbles[n],r=(t-a.bornAtMs)/1e3,l=r/a.ttlSec;a.opacity=Math.max(0,Math.min(1,l<.2?l/.2:l>.8?(1-l)/.2:1)),r>=a.ttlSec&&this.bubbles.splice(n,1)}}}render(){if(this.bubbles.length===0)return;const t=this.canvas.getContext("2d");if(t){t.save(),t.setTransform(1,0,0,1,0,0);for(const e of this.bubbles){const o=e.pos.x-180,n=e.pos.y-120/2;t.globalAlpha=e.opacity,t.fillStyle="rgba(18,22,34,0.92)",t.strokeStyle="#88aaff",t.lineWidth=1,t.fillRect(o,n,360,120),t.strokeRect(o,n,360,120),t.globalAlpha=e.opacity,t.fillStyle="#e6ecff",t.font="13px monospace",t.textAlign="left",t.textBaseline="top";const a=12,r=360-a*2,l=this.wrap(t,e.text,r);let c=n+a;for(const f of l)t.fillText(f,o+a,c),c+=16;const h=(Date.now()-e.bornAtMs)/1e3,u=Math.max(0,Math.min(1,h/e.ttlSec)),d=360-a*2,y=o+a,m=n+120-a-10;t.globalAlpha=.8*e.opacity,t.fillStyle="#2a3350",t.fillRect(y,m,d,8),t.fillStyle="#66aaff",t.fillRect(y,m,d*(1-u),8)}t.restore()}}wrap(t,e,s){const i=e.split(" "),o=[];let n="";for(const a of i){const r=n?`${n} ${a}`:a;t.measureText(r).width>s&&n?(o.push(n),n=a):n=r}return n&&o.push(n),o}pickNextFactIndex(){const t=vt,e=[];for(let s=0;s<t.length;s++)this.shownFacts.has(s)||e.push(s);return e.length===0?null:e[Math.floor(Math.random()*e.length)]}loadShownFacts(){try{const t=localStorage.getItem("shownFacts");t&&(this.shownFacts=new Set(JSON.parse(t)))}catch{}}saveShownFacts(){try{localStorage.setItem("shownFacts",JSON.stringify([...this.shownFacts]))}catch{}}}function te(g,t,e,s){const i=g.magnitude();if(i===0)return p.zero();const o=.5*t*i*i*e*s;return g.normalized().multiply(-1).multiply(o)}function Ct(g,t,e,s,i){return t===0?Number.POSITIVE_INFINITY:Math.sqrt(2*g*i/(t*e*s))}class ee{constructor(t){this.miniAngle=0,this.cachedPath=null,this.lastProjTimeMs=0,this.lastVel=null,this.lastStage=-1,this.lastThrusting=!1,this.cachedInfo=null,this.canvas=t,this.miniPlanetTex=kt(256)}getLastProjectedInfo(){return this.cachedInfo?{apoAlt:this.cachedInfo.apoAlt,periAlt:this.cachedInfo.periAlt}:null}render(t,e,s){const i=this.canvas.getContext("2d");if(!i)return;i.save(),i.setTransform(1,0,0,1,0,0);const o=e.rocket.position,n=o.magnitude(),a=e.rocket.exhaustY??0,r=Math.max(0,-a)+6,l=Math.max(0,n-e.world.planetRadius-r),c=n>1e-6?new p(o.x/n,o.y/n):new p(0,1),h=new p(-c.y,c.x),u=e.world.earthRotationRate||0,d=h.multiply(u*n),y=e.rocket.velocity,m=y.subtract(d),f=e.rocket.isClamped||l<1e3?m.magnitude():y.magnitude(),b=e.rocket.mass,S=e.rocket.fuel,M=e.rocket.throttle,x=e.rocket;let v=0,A=0;if(x.isEngineIgnited&&x.throttle>0){const F=e.world.getGravitationalAcceleration(e.rocket.position.magnitude());v=(x.stages[x.currentStage]?.thrust||0)*M/(b*F),A=x.stages[x.currentStage]?.specificImpulse||0}const C=typeof window<"u"&&(window.devicePixelRatio||1)||1,w=this.canvas.clientWidth||Math.round(this.canvas.width/C),R=this.canvas.clientHeight||Math.round(this.canvas.height/C),T=Math.min(w,R),D=typeof window<"u"&&!!window.matchMedia?.("(pointer: coarse)").matches,W=typeof navigator<"u"&&"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0,z=D||W;let k=1;z&&T<=700?k=1.8:z&&T<=1e3?k=1.5:!z&&T<=1e3?k=1.15:T<1600?k=1:T<2e3?k=.85:k=.8,i.font=`${Math.round(14*k)}px monospace`,i.fillStyle="#ffffff",i.strokeStyle="#000000",i.lineWidth=3;const P=10,$=10,L=250*k,Y=24*k,B=18*k,X=18*k,dt=Y+B*9,ut=8*k,_=12*k,G=dt+ut+X+_;i.fillStyle="rgba(0, 0, 0, 0.7)",i.fillRect(P,$,L,G),i.strokeStyle="#ffffff",i.lineWidth=1,i.strokeRect(P,$,L,G),i.fillStyle="#ffffff";let E=Y;i.fillText(`Altitude:   ${this.formatNumber(l,0)} m`,20,E),E+=B,i.fillStyle="#ffffff";const gt=`Velocity:   ${this.formatNumber(f,1)} m/s`;i.fillText(gt,20,E);const Rt=e.world.getAtmosphericDensity(l),Tt=e.world.getGravitationalAcceleration(e.rocket.position.magnitude()),Et=x.dragCoefficient??e.world.defaultDragCoefficient??.3,Pt=x.crossSectionalArea??e.world.defaultCrossSectionalArea??10,et=Ct(b,Rt,Et,Pt,Tt),It=(Number.isFinite(et)?et:1e4)*1.25+50;let ft="Safe",pt="#00ff66";if(l<8e4&&Number.isFinite(et)){const F=f/Math.max(1,It);if(F>.85){ft="Unsafe";const I=Math.max(0,Math.min(1,(F-.85)/(1.1-.85))),O=(H,U,Yt)=>Math.round(H+(U-H)*Yt),V=O(255,255,I),Q=O(153,51,I),N=O(51,51,I);pt=`#${V.toString(16).padStart(2,"0")}${Q.toString(16).padStart(2,"0")}${N.toString(16).padStart(2,"0")}`}}i.fillStyle=pt;const Lt=i.measureText(gt).width,Ft=10*k;let st=20+Lt+Ft;const mt=P+L-10;st>mt&&(st=mt);const Bt=i.textAlign;i.textAlign="left",i.fillText(ft,st,E),i.textAlign=Bt,i.fillStyle="#ffffff",E+=B,i.fillText(`Mass:       ${this.formatNumber(b,0)} kg`,20,E),E+=B,i.fillText(`Throttle:   ${Math.round(M*100)}%`,20,E),E+=B,i.fillText(`TWR:        ${v.toFixed(2)}`,20,E),E+=B,i.fillText(`ISP:        ${Math.round(A)} s`,20,E),E+=B,i.fillStyle="#ffffff",i.fillText(`Stage:      ${x.currentStage+1}`,20,E),E+=B;const Nt=x.isEngineIgnited?"ON":"OFF",Dt=x.isEngineIgnited?"#00ff00":"#ff0000";i.fillStyle=Dt,i.fillText(`Engines:    ${Nt}`,20,E),E+=B,i.fillStyle="#ffffff";const zt=9.81;let K=0,q=b;const Wt=e.world.getAtmosphericDensity(l),Gt=e.world.surfaceDensity,Ot=Math.max(0,Math.min(1,1-Wt/Math.max(1e-6,Gt)));for(let F=x.currentStage;F<x.stages.length;F++){const I=x.stages[F],O=Math.max(0,I.fuelRemaining);let V=I.specificImpulse??0;if(F===x.currentStage){const N=I.seaLevelIsp??I.specificImpulse??0,H=I.vacuumIsp??I.specificImpulse??0;V=N+(H-N)*Ot}else V=I.vacuumIsp??I.specificImpulse??0;if(O>0&&V>0){const N=Math.max(1e-6,q-O);N>0&&N<q&&(K+=V*zt*Math.log(q/N),q=N)}F<x.stages.length-1&&(q=Math.max(1e-6,q-I.dryMass))}const Ht=K>=1e3?`${(K/1e3).toFixed(2)} km/s`:`${K.toFixed(0)} m/s`;i.fillText(`Delta-V:   ${Ht}`,20,E),E+=B+12*k;const yt=Math.max(180*k,Math.min(L-30*k,220*k)),$t=P+(L-yt)/2;this.drawFuelGauge(i,$t,E,S,x,e,k,yt),this.drawRestartButton(i,k),this.drawMissionTimer(i,s||0,k),this._modeConfirm?.pending&&this.drawModeConfirm(i,this._modeConfirm.targetAuto===!0);const Vt=(e.currentTime||0)*e.world.earthRotationRate;this.miniAngle=Vt,this.drawMiniMap(i,e,k),i.font=`${Math.round(12*k)}px monospace`;const it=["Controls:","Space - Start Engine","B - Cut Engine","T - Full Throttle","G - Zero Throttle","Up/Down - Throttle Â±10%","Left/Right - Turn","S - Stage","Scroll - Zoom"];let ot=0;for(const F of it){const I=i.measureText(F).width;I>ot&&(ot=I)}const Z=10,xt=15*k,wt=Math.ceil(ot)+Z*2,nt=xt*it.length+Z*2,bt=10,at=this.canvas.height-nt-20;i.fillStyle="rgba(0, 0, 0, 0.5)",i.fillRect(bt,at,wt,nt),i.strokeStyle="#ffffff",i.lineWidth=1,i.strokeRect(bt,at,wt,nt),i.fillStyle="#ffffff";let St=at+Z+12;for(const F of it)i.fillText(F,P+Z,St),St+=xt;if(e.autopilotRunning){const F="Auto Pilot Active";i.save(),i.font="14px monospace";const Q=i.measureText(F),N=Math.ceil(Q.width)+24,H=Math.round((this.canvas.width-N)/2),U=this.canvas.height-22-14;i.fillStyle="rgba(0, 230, 118, 0.12)",i.fillRect(H,U,N,22),i.strokeStyle="#00e676",i.lineWidth=1,i.strokeRect(H+.5,U+.5,N-1,21),i.fillStyle="#00e676",i.textBaseline="middle",i.textAlign="center",i.fillText(F,Math.round(H+N/2),Math.round(U+22/2)),i.textAlign="left",i.restore()}i.restore()}drawMiniMap(t,e,s=1){const i=Math.round(18*s),o=Math.max(120,Math.round(160*s)),n=this.canvas.width-o-i,a=this.canvas.height-o-i;t.fillStyle="rgba(0, 0, 0, 0.65)",t.fillRect(n,a,o,o),t.strokeStyle="#88aaff",t.lineWidth=Math.max(1,Math.round(1*s)),t.strokeRect(n,a,o,o);const r=n+o/2,l=a+o/2,c=e.world.planetRadius,h=Math.min(o*.24,o*.26),u=o/2-Math.max(4,Math.round(6*s));if(this.miniPlanetTex){t.save(),t.translate(r,l);const C=e.world.earthRotationRate||0,R=-(Math.PI/2+C*e.currentTime);t.rotate(R);const T=h*2;t.drawImage(this.miniPlanetTex,-T/2,-T/2,T,T),t.restore()}else t.beginPath(),t.arc(r,l,h,0,Math.PI*2),t.fillStyle="#0b3766",t.fill(),t.strokeStyle="#204f25",t.stroke();const d=this.getProjectedPath(e,8*3600,1),y=this.cachedPath||[];let m=c;for(let C=0;C<y.length;C++){const w=y[C],R=Math.hypot(w.x,w.y);R>m&&(m=R)}if(d.apoAlt&&Number.isFinite(d.apoAlt)){const C=c+Math.max(0,d.apoAlt);C>m&&(m=C)}const f=Math.min(m,c*6),b=Math.max(1e6,f-c),S=(C,w)=>{const R=Math.hypot(C,w),T=R>0?C/R:0,D=R>0?w/R:1,W=Math.max(0,R-c),z=25e4,$=Math.min(1,Math.log1p(W/z)/Math.log1p(b/z))**1.6,L=h+(u-h)*$,Y=T*L,B=D*L,X=r+Y,j=l-B;return{sx:X,sy:j}},M=this.cachedPath||[];if(M.length>1){const w=Math.max(1,Math.floor(M.length/1e3)),R=Math.max(1,1.1*s);t.fillStyle="rgba(200,220,255,0.9)";for(let k=0;k<M.length;k+=w){const P=S(M[k].x,M[k].y);t.beginPath(),t.arc(P.sx,P.sy,R,0,Math.PI*2),t.fill()}if(d.apoPos){const k=S(d.apoPos.x,d.apoPos.y);t.fillStyle="#00ff66",t.beginPath(),t.arc(k.sx,k.sy,2.2,0,Math.PI*2),t.fill()}if(d.periPos){const k=S(d.periPos.x,d.periPos.y);t.fillStyle="#ff3333",t.beginPath(),t.arc(k.sx,k.sy,2.2,0,Math.PI*2),t.fill()}const T=a-Math.round(24*s),D=a-Math.round(10*s);t.font=`${Math.round(12*s)}px monospace`,t.fillStyle="#00ff66";const W=Number.isFinite(d.apoAlt)?`${(d.apoAlt/1e3).toFixed(0)} km`:"âˆž (escape)";t.fillText(`Apoapsis: ${W}`,n,T),t.fillStyle="#ff6666";const z=Number.isFinite(d.periAlt)?`${(d.periAlt/1e3).toFixed(0)} km`:"â€”";if(t.fillText(`Periapsis: ${z}`,n,D),d.stableOrbit){t.fillStyle="#00ff99";const k=a-Math.round(54*s);t.fillText("Stable orbit achieved! ðŸŽ‰",n,k)}}const x=e.rocket.position,v=S(x.x,x.y),A=Math.max(3,Math.round(4*s));t.strokeStyle="#ffcc00",t.lineWidth=2,t.beginPath(),t.moveTo(v.sx-A,v.sy-A),t.lineTo(v.sx+A,v.sy+A),t.moveTo(v.sx-A,v.sy+A),t.lineTo(v.sx+A,v.sy-A),t.stroke(),t.font=`${Math.round(11*s)}px monospace`,t.fillStyle="#a8c0ff",t.fillText("Orbit view",n+8,a+14)}computeProjectedPath(t,e,s){const i=t.world.gravitationalParameter,o=[];let n=t.rocket.position.x,a=t.rocket.position.y,r=t.rocket.velocity.x,l=t.rocket.velocity.y;const c=Math.max(.05,s);for(let h=0;h<e;h++){const u=n*n+a*a,d=Math.sqrt(u);if(d<=t.world.planetRadius)break;const y=1/(u*d),m=-i*n*y,f=-i*a*y;r+=m*c,l+=f*c,n+=r*c,a+=l*c,o.push({x:n,y:a})}return o}getProjectedPath(t,e,s){const i=Date.now(),o=t.rocket.isEngineIgnited&&t.rocket.throttle>0,n=t.rocket.velocity,a=t.rocket.currentStage,l=t.rocket.position.magnitude()-t.world.planetRadius,c=!o&&l>=8e4;let h=!1;if(this.cachedPath||(h=!0),(this.lastThrusting!==o||this.lastStage!==a)&&(h=!0),this.lastVel&&!c){const m=n.x-this.lastVel.x,f=n.y-this.lastVel.y;if(Math.hypot(m,f)>.5)h=!0;else{const S=this.lastVel,M=S.x*n.x+S.y*n.y,x=Math.hypot(S.x,S.y),v=Math.hypot(n.x,n.y);if(x>.001&&v>.001){const A=Math.min(1,Math.max(-1,M/(x*v)));Math.acos(A)>.5*Math.PI/180&&(h=!0)}}}else h=!0;const u=c?1e4:1e3;if(!h&&i-this.lastProjTimeMs<u&&this.cachedInfo)return this.cachedInfo;if(!h&&this.cachedInfo)return this.cachedInfo;const d=this.computeProjectedPathInfo(t,e,s),y=d.points;return this.cachedPath=y,this.lastProjTimeMs=i,this.lastVel={x:n.x,y:n.y},this.lastStage=a,this.lastThrusting=o,this.cachedInfo={apoAlt:d.apoAlt,apoPos:d.apoPos,periAlt:d.periAlt,periPos:d.periPos,stableOrbit:d.stableOrbit},this.cachedInfo}computeProjectedPathInfo(t,e,s){const i=t.world.gravitationalParameter,o=t.world.planetRadius,n=[];let a=t.rocket.position.x,r=t.rocket.position.y,l=t.rocket.velocity.x,c=t.rocket.velocity.y;const h=Math.hypot(a,r),u=l*l+c*c,d=a*l+r*c,y=1/i*((u-i/h)*a-d*l),m=1/i*((u-i/h)*r-d*c),f=Math.hypot(y,m),b=Math.abs(a*c-r*l),S=b*b/(i*(1+f));let M=Number.POSITIVE_INFINITY;f<1&&(M=b*b/(i*(1-f)));let x=Number.isFinite(M)?Math.max(0,M-o):Number.POSITIVE_INFINITY;const v=Math.max(0,S-o);let A=null,C=null;const w=8e4;let R=f<1&&S-o>w;const T=P=>P<3600?1:P<3*3600?5:P<6*3600?15:30;let D=Math.atan2(r,a),W=0;const z=o*6;let k=0;for(;;){const P=T(k);if(k>=e)break;const $=a*a+r*r,L=Math.sqrt($),Y=L-o;if(L<=o)break;Number.isFinite(M)?(!A&&Math.abs(L-M)<1e3&&(A={x:a,y:r}),!C&&Math.abs(L-S)<1e3&&(C={x:a,y:r})):(!A||L>Math.hypot(A.x,A.y))&&(A={x:a,y:r},x=Y),n.push({x:a,y:r});const B=1/($*L),X=-i*a*B,j=-i*r*B;if(l+=X*P,c+=j*P,a+=l*P,r+=c*P,k+=P,.5*(l*l+c*c)-i/L>0&&L>z)break;const _=Math.atan2(r,a);let G=_-D;if(G>Math.PI&&(G-=2*Math.PI),G<-Math.PI&&(G+=2*Math.PI),W+=Math.abs(G),D=_,!R&&f<1&&W>=2*Math.PI&&S-o>w){R=!0;break}}return Number.isFinite(M)||(x=Number.POSITIVE_INFINITY),{points:n,apoAlt:x,apoPos:A,periAlt:v,periPos:C,stableOrbit:R}}formatNumber(t,e=0){return t>=1e6?`${(t/1e6).toFixed(e)}M`:t>=1e3?`${(t/1e3).toFixed(e)}k`:t.toFixed(e)}drawRocketPositionIndicator(t,e){const o=this.canvas.width-180-20,n=this.canvas.height-120-20;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(o,n,180,120),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(o,n,180,120);const a=e.rocket.position;e.world.getAltitude(a.magnitude());const r=e.rocket.rotation,l=e.rocket.velocity,c=n+120-30,h=o+180/2;t.fillStyle="#8B4513",t.fillRect(o+1,c,178,30);const u=t.createLinearGradient(0,n+1,0,c);u.addColorStop(0,"#87CEEB"),u.addColorStop(1,"#4169E1"),t.fillStyle=u,t.fillRect(o+1,n+1,178,c-n-1),t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.moveTo(o+10,c),t.lineTo(o+180-10,c),t.stroke(),this.drawRocketIcon(t,h,c-20,r,e.rocket.isEngineIgnited),l.magnitude()>1&&this.drawVelocityArrow(t,h,c-20,l,r),t.fillStyle="#ffffff",t.font="11px monospace";const d=(r*180/Math.PI).toFixed(0);t.fillText(`Attitude: ${d}Â°`,o+10,n+15);const y=l.magnitude(),m=(Math.atan2(l.x,l.y)*180/Math.PI).toFixed(0);t.fillText(`Velocity: ${y.toFixed(1)} m/s`,o+10,n+30),t.fillText(`Direction: ${m}Â°`,o+10,n+45);const f=a.magnitude();t.fillText(`Radius: ${this.formatNumber(f,1)} m`,o+10,n+60),t.font="12px monospace",t.textAlign="center",t.fillText("POSITION & ATTITUDE",h,n+120-5),t.textAlign="left"}drawRocketIcon(t,e,s,i,o){t.save(),t.translate(e,s),t.rotate(i),t.fillStyle="#ffffff",t.fillRect(-2,-8,4,16),t.fillStyle="#ff8800",t.beginPath(),t.moveTo(0,-8),t.lineTo(-2,-12),t.lineTo(2,-12),t.closePath(),t.fill(),o&&(t.fillStyle="#ff4500",t.fillRect(-1,8,2,6)),t.fillStyle="#666666",t.fillRect(-3,4,2,4),t.fillRect(1,4,2,4),t.restore()}drawVelocityArrow(t,e,s,i,o){const n=Math.atan2(i.x,i.y),a=20;t.save(),t.translate(e,s),t.strokeStyle="#00ff00",t.lineWidth=2;const r=Math.sin(n)*a,l=-Math.cos(n)*a;t.beginPath(),t.moveTo(0,0),t.lineTo(r,l),t.stroke(),t.save(),t.translate(r,l),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-3,-6),t.lineTo(3,-6),t.closePath(),t.fillStyle="#00ff00",t.fill(),t.restore(),t.restore()}drawFuelGauge(t,e,s,i,o,n,a=1,r){const l=o.stages[o.currentStage];if(!l)return;const c=l.propellantMass,h=l.fuelRemaining,u=Math.min(1,Math.max(0,h/c)),d=typeof r=="number"?r:200*a,y=20*a;t.fillStyle="#ffffff",t.font=`${Math.round(14*a)}px monospace`,t.fillText(`Fuel: ${this.formatNumber(h,0)}/${this.formatNumber(c,0)} kg`,e,s-5),t.fillStyle="#333333",t.fillRect(e,s,d,y),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(e,s,d,y);const m=d*u;let f;u>.5?f="#00ff00":u>.2?f="#ffff00":f="#ff0000",t.fillStyle=f,t.fillRect(e+1,s+1,m-2,y-2),t.fillStyle="#ffffff",t.font=`${Math.round(12*a)}px monospace`;const b=`${Math.round(u*100)}%`,S=t.measureText(b).width;t.fillText(b,e+d/2-S/2,s+Math.round(14*a))}drawMissionTimer(t,e,s=1){const i=e/2,o=Math.floor(i/60),n=Math.floor(i%60),a=`${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`,r=140*s,l=30*s,c=10,h=Math.round(18*s),u=Math.max(120,Math.round(160*s)),y=this.canvas.width-u-h+u/2,m=Math.round(2*s),f=Math.round(y-r/2+m),b=30*s,S=Math.round(6*s),M=c+b+S;t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(f,M,r,l),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(f,M,r,l),t.fillStyle="#ffffff",t.font=`${Math.round(14*s)}px monospace`,t.textAlign="center",t.fillText(`Mission: ${a}`,f+r/2,M+Math.round(20*s)),t.textAlign="left"}drawRestartButton(t,e=1){const s=140*e,i=30*e,o=10,n=Math.round(18*e),a=Math.max(120,Math.round(160*e)),l=this.canvas.width-a-n+a/2,c=Math.round(2*e),h=Math.round(l-s/2+c),u=o;t.fillStyle="rgba(200, 50, 50, 0.8)",t.fillRect(h,u,s,i),t.strokeStyle="#ff6666",t.lineWidth=1,t.strokeRect(h,u,s,i),t.fillStyle="#ffffff",t.font=`${Math.round(14*e)}px monospace`,t.textAlign="center",t.fillText("MENU",h+s/2,u+Math.round(20*e)),t.textAlign="left",this.restartButtonBounds={x:h,y:u,width:s,height:i}}setModeConfirm(t,e){this._modeConfirm={pending:t,targetAuto:e}}drawModeConfirm(t,e){t.fillStyle="rgba(0,0,0,0.6)",t.fillRect(0,0,this.canvas.width,this.canvas.height);const s=360,i=120,o=(this.canvas.width-s)/2,n=(this.canvas.height-i)/2;t.fillStyle="rgba(20,20,30,0.95)",t.strokeStyle="#88aaff",t.lineWidth=2,t.fillRect(o,n,s,i),t.strokeRect(o,n,s,i),t.fillStyle="#ffffff",t.font="14px monospace";const a=e?"Restart into Auto Pilot mode?":"Restart into Manual mode?";t.textAlign="center",t.fillText(a,o+s/2,n+35);const r=120,l=28,c=o+40,h=o+s-40-r,u=n+i-45;t.fillStyle="#2d6a3e",t.fillRect(c,u,r,l),t.strokeStyle="#55cc77",t.strokeRect(c,u,r,l),t.fillStyle="#ffffff",t.fillText("YES",c+r/2,u+19),t.fillStyle="#7a2d2d",t.strokeStyle="#ff7777",t.fillRect(h,u,r,l),t.strokeRect(h,u,r,l),t.fillStyle="#ffffff",t.fillText("NO",h+r/2,u+19),this.confirmYesBounds={x:c,y:u,width:r,height:l},this.confirmNoBounds={x:h,y:u,width:r,height:l},t.textAlign="left"}handleResize(){}}function se(g,t){const e=g.position;let s=g.velocity;const i=s.magnitude(),o=g.world.getAltitude(e.magnitude());if(o>=8e4)return{velocity:s,heatLevel:Math.max(0,g.heatLevel-10*t),atmosphericGlow:g.atmosphericGlow,hasBurnedUp:g.hasBurnedUp};const n=g.world.getAtmosphericDensity(o),a=g.world.getGravitationalAcceleration(e.magnitude()),r=g.mass,l=g.aeroCdEff,c=g.aeroAreaEff,h=Ct(r,n,l,c,a),u=(Number.isFinite(h)?h:1e4)*1.35+50;let d=g.heatLevel,y=g.atmosphericGlow,m=g.hasBurnedUp,f,b=!1,S=!1;if(i>u&&i>0){const v=i/Math.max(1,u),A=Math.min(1,n/g.world.surfaceDensity),C=Math.max(0,v-1),w=(1.5+8*A)*C**.7,R=s.multiply(1/i),T=w*t,D=Math.max(0,i-T);s=R.multiply(D),d+=(v-1)*(.4+.8*A)*50*t}else{const v=i/Math.max(1,u);if(v>.85){const A=Math.min(1,n/g.world.surfaceDensity);d+=(v-.85)*20*A*t}else d=Math.max(0,d-15*t)}const M=Math.min(1,n/g.world.surfaceDensity*(i/(u+1)));y=Math.max(y,M),!m&&d>=100&&(m=!0,f="Thermal failure (overheating)",b=!0,S=!0);let x=g.overspeedTime||0;if(!g.isGameOver&&!g.world.isInSpace(o)&&Number.isFinite(u)&&i>u*1.2){if(x+=t,x>1){const v=i/u,A=Math.min(1,n/g.world.surfaceDensity),C=Math.min(.9,(v-1.2)*(v-1.2)*(.35+.65*A)),w=1-Math.exp(-C*t);Math.random()<w&&(f="Aerodynamic structural failure (overspeed)",b=!0,S=!0)}}else x=0;return{velocity:s,heatLevel:d,atmosphericGlow:y,hasBurnedUp:m,gameOverReason:f,explode:b,destroy:S,overspeedTime:x}}class ie{constructor(t){this.queue=[],this.running=!1,this.logFn=null,this.engine=t}setLogger(t){this.logFn=t}log(t){this.logFn&&this.logFn(t)}update(t){if(!this.running||this.queue.length===0)return;const e=this.queue[0];e.tick(t)&&(this.queue.shift(),e.onComplete?.(this.queue.length),this.queue.length===0&&(this.running=!1,this.engine.setAutopilotHold("none"),this.engine.setGameSpeed(1),this.log?.("> script complete")))}stop(){this.queue.length&&this.queue[0].onStop&&this.queue[0].onStop?.(),this.queue=[],this.running=!1,this.engine.setAutopilotHold("none")}isRunning(){return this.running&&this.queue.length>0}runScript(t){this.stop();let e=t.replace(/\s*\/\/\/\/\s*/g,`
`);e=e.replace(/\bthen\b/gi,`
`);const s=["ignite","ignit","start","engine on","cut","engine off","stop","hold","throttle","wait","burn_until","pitch"];for(const n of s){const a=new RegExp(`(?!^)\\b${n.replace(" ","\\s+")}\\b`,"gi");e=e.replace(a,r=>`
${r}`)}const i=e.split(/\n+/).map(n=>n.trim()).filter(Boolean);let o=!0;for(const n of i)o=this.enqueueCommand(n)&&o;if(!o){this.log("ERR: Script has errors; nothing started."),this.queue=[],this.running=!1;return}this.running=this.queue.length>0,this.log(`Queued ${this.queue.length} steps.`)}runCommand(t){let e=t.replace(/\s*\/\/\/\/\s*/g,`
`);e=e.replace(/\bthen\b/gi,`
`);const s=["ignite","ignit","start","engine on","cut","engine off","stop","hold","throttle","wait","burn_until","pitch"];for(const n of s){const a=new RegExp(`(?!^)\\b${n.replace(" ","\\s+")}\\b`,"gi");e=e.replace(a,r=>`
${r}`)}const i=e.split(/\n+/).map(n=>n.trim()).filter(Boolean);let o=!0;for(const n of i)o=this.enqueueCommand(n)&&o;if(!o){this.log("ERR: Command has errors; nothing started.");return}this.running=this.queue.length>0}enqueueCommand(t){const e=t.replace(/#/g,"//").split("//")[0].trim();if(!e)return!0;const s=e.toLowerCase();if(s.startsWith("throttle")){const i=e.match(/throttle\s+([0-9.]+)/i),o=i?Math.max(0,Math.min(1,Number.parseFloat(i[1]))):0;return!i||Number.isNaN(o)?(this.log(`ERR: throttle expects a number 0..1 (in: "${e}")`),!1):(this.queue.push({tick:()=>(this.engine.setThrottle(o),this.log(`throttle ${o}`),!0)}),!0)}if(s==="ignite"||s==="ignit"||s==="engine on"||s==="start")return this.queue.push({tick:()=>(this.engine.igniteEngines(),this.log("ignite"),!0)}),!0;if(s==="cut"||s==="engine off"||s==="stop")return this.queue.push({tick:()=>(this.engine.cutEngines(),this.log("cut"),!0)}),!0;if(s==="stage")return this.queue.push({tick:()=>(this.engine.performStaging(),this.log("stage"),!0)}),!0;if(s.startsWith("wait")){const i=e.match(/wait\s+([0-9.]+)/i),o=/wait\s+until\s+apoapsis/i.test(e),n=/wait\s+until\s+periapsis/i.test(e),a=e.match(/wait\s+until\s+altitude\s+([0-9_.]+)/i),r=/wait\s+until\s+stage\s+(empty|depleted)/i.test(e);if(o)return this.queue.push(this.waitApo()),!0;if(n)return this.queue.push(this.waitPeri()),!0;if(r)return this.queue.push(this.waitStageEmpty()),!0;if(a){const c=Number.parseFloat(a[1].replace(/_/g,""));return Number.isFinite(c)?(this.queue.push(this.waitAlt(c)),!0):(this.log(`ERR: wait until altitude expects a number (in: "${e}")`),!1)}let l=i?Number.parseFloat(i[1]):Number.NaN;return!i||Number.isNaN(l)?(this.log(`ERR: wait expects seconds or "wait until apoapsis|periapsis|altitude N" (in: "${e}")`),!1):(this.queue.push({tick:c=>(l-=c,l<=0)}),!0)}if(s.startsWith("hold")){const i=e.match(/hold\s+(prograde|retrograde|up|none)/i),o=(i?i[1]:"none").toLowerCase();return this.queue.push({tick:()=>(this.engine.setAutopilotHold(o),this.log(`hold ${o}`),!0)}),!0}if(s.startsWith("pitch")){const i=e.match(/pitch\s+(east|west)\s+([0-9.]+)/i);if(!i)return this.log(`ERR: pitch expects 'pitch east|west <deg>' (in: "${e}")`),!1;const o=i[1].toLowerCase(),n=Number.parseFloat(i[2]);if(!Number.isFinite(n))return this.log(`ERR: pitch angle invalid (in: "${e}")`),!1;const a=o==="east"?-Math.abs(n):Math.abs(n);return this.queue.push({tick:()=>(this.engine.setAutopilotTargetAngle(a),this.log(`pitch ${o} ${n}`),!0)}),!0}if(s.startsWith("until apoapsis")){const i=e.match(/apoapsis\s*(?:=|>=|<=)?\s*([0-9_.]+)/i),o=e.match(/throttle\s*([0-9.]+)/i),n=i?Number.parseFloat(i[1].replace(/_/g,"")):Number.NaN,a=o?Math.max(0,Math.min(1,Number.parseFloat(o[1]))):void 0;return Number.isFinite(n)?(this.queue.push(this.untilApo(n,a)),!0):(this.queue.push(this.waitApo()),!0)}if(s.startsWith("until stage"))return/until\s+stage\s+(empty|depleted)/i.test(e)?(this.queue.push(this.waitStageEmpty()),!0):(this.log(`ERR: until stage expects 'empty|depleted' (in: "${e}")`),!1);if(s.startsWith("burn_until apoapsis")){const i=e.match(/apoapsis\s*([0-9_.]+)/i),o=e.match(/throttle\s*([0-9.]+)/i),n=i?Number.parseFloat(i[1].replace(/_/g,"")):Number.NaN,a=o?Math.max(0,Math.min(1,Number.parseFloat(o[1]))):1;return Number.isFinite(n)?(this.queue.push(this.untilApo(n,a)),!0):(this.log(`ERR: burn_until apoapsis expects a number (in: "${e}")`),!1)}if(s.startsWith("until periapsis")){const i=e.match(/periapsis\s*(?:=|>=|<=)?\s*([0-9_.]+)/i),o=e.match(/throttle\s*([0-9.]+)/i),n=i?Number.parseFloat(i[1].replace(/_/g,"")):Number.NaN,a=o?Math.max(0,Math.min(1,Number.parseFloat(o[1]))):void 0;return Number.isFinite(n)?(this.queue.push(this.untilPeri(n,a)),!0):(this.queue.push(this.waitPeri()),!0)}if(s.startsWith("until twr")){const i=e.match(/twr\s*([<>]=?)\s*([0-9.]+)/i),o=e.match(/throttle\s*([0-9.]+)/i);if(i){const n=i[1],a=Number.parseFloat(i[2]),r=o?Math.max(0,Math.min(1,Number.parseFloat(o[1]))):void 0;return Number.isFinite(a)?(this.queue.push(this.untilTwr(n,a,r)),!0):(this.log(`ERR: until twr expects a number (in: "${e}")`),!1)}return this.log(`ERR: until twr expects '<= or >=' then a number (in: "${e}")`),!1}return this.queue.push({tick:()=>(this.log(`ERR: Unknown command: ${e}`),!0)}),!1}untilApo(t,e){let s=Number.NaN;return{tick:i=>{if(!Number.isFinite(t))return!0;typeof e=="number"&&this.engine.setThrottle(e),!this.engine.isEngineOn()&&(e??0)>0&&this.engine.igniteEngines();const o=this.engine.getApoapsisAltitude();return o>=t&&(!Number.isNaN(s)&&o>s+.01||!Number.isNaN(s)&&o<=t)||(s=o,o>=t)},onComplete:i=>{i===0&&this.engine.cutEngines()}}}untilTwr(t,e,s){const i=o=>t==="<="?o<=e:t===">="?o>=e:!1;return{tick:o=>{typeof s=="number"&&this.engine.setThrottle(s);const n=this.engine.getCurrentTWR();return i(n)}}}untilPeri(t,e){let s=Number.NaN;return{tick:i=>{if(!Number.isFinite(t))return!0;typeof e=="number"&&this.engine.setThrottle(e),!this.engine.isEngineOn()&&(e??0)>0&&this.engine.igniteEngines();const o=this.engine.getPeriapsisAltitude();return o>=t&&(!Number.isNaN(s)&&o>s+.01||!Number.isNaN(s)&&o<=t)||(s=o,o>=t)},onComplete:i=>{i===0&&this.engine.cutEngines()}}}waitApo(){let t=!1;return{tick:e=>(t||(this.engine.setGameSpeed(10),t=!0),this.engine.getRadialVelocity()<=0),onStop:()=>{this.engine.setGameSpeed(1)},onComplete:()=>{this.engine.setGameSpeed(1)}}}waitPeri(){return{tick:t=>this.engine.getRadialVelocity()>=0}}waitAlt(t){return{tick:e=>Number.isFinite(t)?this.engine.getAltitude()>=t:!0}}waitStageEmpty(){return{tick:t=>{const e=this.engine.getActiveStageFuel();return Number.isFinite(e)?e<=1:!1}}}}class oe{constructor(t){this.context=t}updateContext(t){Object.assign(this.context,t)}igniteEngines(){const{gameState:t,rocketConfig:e,soundSystem:s,debugLog:i}=this.context,o=e.getActiveStage();if(!o||o.fuelRemaining<=0)return i("âŒ Cannot ignite - no fuel remaining in current stage!"),!1;const n=e.getCurrentThrust();return i(`Attempting ignition - thrust: ${n}, fuel: ${o.fuelRemaining}kg`),n>0?(t.rocket.isEngineIgnited=!0,t.rocket.hasEverLaunched=!0,t.rocket.throttle=.5,t.rocket.isClamped&&(t.rocket.isClamped=!1,i("ðŸ§° Pad clamps auto-released. Liftoff!")),i("âœ… Engine start! Throttle 50%"),s.playEngineIgnite(),!0):(i("âŒ No thrust available - ignition failed"),!1)}setThrottle(t){const{gameState:e,soundSystem:s,debugLog:i}=this.context;e.rocket.throttle=Math.max(0,Math.min(1,t)),i(`Throttle set to ${(e.rocket.throttle*100).toFixed(0)}%`),e.rocket.isEngineIgnited&&s.setEngineThrottle(e.rocket.throttle)}cutEngines(){const{gameState:t,soundSystem:e,debugLog:s}=this.context;t.rocket.isEngineIgnited=!1,t.rocket.throttle=0,s("ðŸ”¥ Engines cut! Complete engine shutdown."),e.stopEngine()}performStaging(){const{gameState:t,rocketBody:e,rocketConfig:s,effectsSystem:i,soundSystem:o,stageManager:n,rocketRenderer:a,debugLog:r,destroyRocket:l}=this.context,c=s.getCurrentThrust()*t.rocket.throttle;if(s.wouldExplodeOnStaging(c))return r("ðŸ’¥ EXPLOSION! Cannot stage with engines firing - catastrophic failure!"),i.createExplosion(t.rocket.position,t.rocket.velocity),o.playExplosion(),l("Staging while engines firing"),!1;const h=e.position.clone(),u=e.velocity.clone();if(s.performStaging()){t.rocket.currentStage=s.getCurrentStageIndex(),e.position=h,e.velocity=u,e.setMass(s.getCurrentMass());const d=new p(Math.sin(t.rocket.rotation),-Math.cos(t.rocket.rotation)),y=a.getRocketBounds(t.rocket);return n.createStagingAnimation(t,d,t.rocket.exhaustY,y.height),r("âœ… Stage separated safely! Position and velocity preserved."),!0}return r("Cannot stage - no more stages available"),!1}nudgeThrottle(t){const e=Math.max(0,Math.min(1,this.context.gameState.rocket.throttle+t));this.setThrottle(e)}}class J{constructor(){this.debris=[],this.smoke=[],this.explosions=[]}addDebris(t,e,s,i,o=6){this.debris.push({pos:t.clone(),vel:e.clone(),rotation:s,rotSpeed:i,life:o}),this.debris.length>80&&this.debris.shift()}addSmoke(t,e,s=8,i=1.8){this.smoke.push({pos:t.clone(),vel:e.clone(),life:0,maxLife:i,size:s}),this.smoke.length>120&&this.smoke.splice(0,this.smoke.length-120)}createExplosion(t,e){const s=[];for(let i=0;i<30;i++){const o=Math.PI*2*i/30+Math.random()*.2,n=40+Math.random()*60,a=new p(Math.cos(o)*n+e.x*.1,Math.sin(o)*n+e.y*.1),r=i%2===0?"#ffcc66":"#ff6633",l=2+Math.random()*3;s.push({pos:t.clone(),vel:a,color:r,size:l})}this.explosions.push({pos:t.clone(),vel:e.clone(),life:0,maxLife:2,size:16,particles:s}),this.explosions.length>8&&this.explosions.shift()}update(t){for(let e=this.debris.length-1;e>=0;e--){const s=this.debris[e];s.pos=s.pos.add(s.vel.multiply(t)),s.rotation+=s.rotSpeed*t,s.life-=t,s.life<=0&&this.debris.splice(e,1)}for(let e=this.smoke.length-1;e>=0;e--){const s=this.smoke[e];s.life+=t,s.pos=s.pos.add(s.vel.multiply(t)),s.life>=s.maxLife&&this.smoke.splice(e,1)}for(let e=this.explosions.length-1;e>=0;e--){const s=this.explosions[e];s.life+=t,s.pos=s.pos.add(s.vel.multiply(t));for(const i of s.particles)i.pos=i.pos.add(i.vel.multiply(t));s.life>=s.maxLife&&this.explosions.splice(e,1)}}drawBehind(t){for(const e of this.smoke){const s=Math.max(0,Math.min(1,e.life/e.maxLife)),i=1-s,o=e.size*(1+s*1.2);t.drawCircle(e.pos,o,`rgba(200,200,200,${i*.6})`)}}drawFront(t){for(const e of this.debris)t.drawRotated(e.pos,e.rotation,()=>{t.drawRectangle(new p(-2,-1),4,2,"rgba(180,180,180,0.8)")});for(const e of this.explosions){const s=e.life/e.maxLife;for(const n of e.particles)t.drawCircle(n.pos,n.size,n.color);const i=e.size*(1+s*2),o=1-s;t.drawCircle(e.pos,i,`rgba(255,220,160,${o})`)}}}class ne{constructor(){this.velocityStreaks=[],this.atmosphericGlow=0,this.heatLevel=0,this.hasBurnedUp=!1,this.stagingVis=new J}reset(){this.stagingVis=new J,this.velocityStreaks=[],this.atmosphericGlow=0,this.heatLevel=0,this.hasBurnedUp=!1}update(t){this.stagingVis.update(t);for(let e=this.velocityStreaks.length-1;e>=0;e--){const s=this.velocityStreaks[e];s.life-=t*2,s.pos=s.pos.add(s.vel.multiply(t)),s.life<=0&&this.velocityStreaks.splice(e,1)}}render(t,e){this.stagingVis.drawBehind(t),this.drawSpeedEffects(t)}renderFront(t){this.stagingVis.drawFront(t)}updateSpeedEffects(t,e,s,i,o){const n=e.rocket.velocity,a=n.magnitude(),r=e.rocket.position,l=s.getAltitude(r.magnitude());e.rocket.rotation;const c=r.add(i.multiply(o)),h=s.getAtmosphericDensity(l),u=50,m=Math.min(1,Math.max(0,(a-u)/(1e3-u)))*h;if(this.atmosphericGlow=m,m>.1&&Math.random()<m){const f=new p((Math.random()-.5)*20,(Math.random()-.5)*20);this.velocityStreaks.push({pos:c.add(f),vel:n.multiply(-.5).add(new p((Math.random()-.5)*10,(Math.random()-.5)*10)),life:.5+Math.random()*.5,intensity:m})}this.velocityStreaks.length>30&&this.velocityStreaks.splice(0,this.velocityStreaks.length-30)}createEngineSmoke(t,e,s,i){const o=t.rocket.position,n=t.rocket.velocity,a=e.getAltitude(o.magnitude());if(a>5e4||!t.rocket.isEngineIgnited)return;const r=e.getAtmosphericDensity(a),l=Math.min(1,r*2);if(l>.01){const c=Math.floor(3*l*t.rocket.throttle);for(let h=0;h<c;h++){const u=new p((Math.random()-.5)*6,(Math.random()-.5)*6),d=s.multiply(5+Math.random()*3),y=new p(i.x+d.x+u.x,i.y+d.y+u.y),m=90+140*t.rocket.throttle,f=s,b=new p(f.x*m+n.x*.15+(Math.random()-.5)*12,f.y*m+n.y*.15+(Math.random()-.5)*12);this.stagingVis.addSmoke(y,b,(4+Math.random()*8)*l,3*l)}}}createExplosion(t,e){this.stagingVis.createExplosion(t.clone(),e.multiply(.1))}createDestructionDebris(t,e){for(let s=0;s<20;s++){const i=t.add(new p((Math.random()-.5)*50,(Math.random()-.5)*50)),o=e.add(new p((Math.random()-.5)*100,(Math.random()-.5)*100));this.stagingVis.addDebris(i,o,Math.random()*Math.PI*2,(Math.random()-.5)*10,3+Math.random()*2)}}drawSpeedEffects(t){for(const e of this.velocityStreaks){const s=Math.max(0,e.life)*e.intensity,i=2+e.intensity*3;t.drawCircle(e.pos,i,`rgba(255, 200, 100, ${s*.5})`,void 0,0)}}getAtmosphericGlow(){return this.atmosphericGlow}setAtmosphericGlow(t){this.atmosphericGlow=t}getHeatLevel(){return this.heatLevel}setHeatLevel(t){this.heatLevel=t}hasBurnedUpStatus(){return this.hasBurnedUp}setHasBurnedUp(t){this.hasBurnedUp=t}}class ct{constructor(t,e,s){this.rotation=0,this.angularVelocity=0,this.forces=[],this.torques=[],this.previousAcceleration=p.zero(),this.position=t.clone(),this.velocity=e.clone(),this.mass=s}applyForce(t){this.forces.push(t.clone())}applyForceAtPoint(t,e){this.forces.push(t.clone());const s=-e.cross(t);this.torques.push(s)}applyTorque(t){this.torques.push(t)}getAcceleration(){return this.mass<=0?p.zero():this.forces.reduce((e,s)=>e.add(s),p.zero()).divide(this.mass)}getAngularAcceleration(t){return t<=0?0:this.torques.reduce((s,i)=>s+i,0)/t}integrate(t,e=1e3){const s=this.getAcceleration(),i=this.getAngularAcceleration(e);if(!rt.isStable(this.velocity,s,t)){console.warn("Physics integration unstable, clamping values");return}rt.integrateMotion(this.position,this.velocity,s,t),this.angularVelocity+=i*t,this.rotation+=this.angularVelocity*t,this.rotation>Math.PI&&(this.rotation-=2*Math.PI),this.rotation<-Math.PI&&(this.rotation+=2*Math.PI),this.previousAcceleration=s,this.clearForces()}clearForces(){this.forces.length=0,this.torques.length=0}getKineticEnergy(t){const e=.5*this.mass*this.velocity.magnitudeSquared(),s=.5*t*this.angularVelocity*this.angularVelocity;return e+s}getMomentum(){return this.velocity.multiply(this.mass)}setMass(t){if(t<=0){console.warn("Invalid mass, keeping current mass");return}this.mass=t}getForwardDirection(){return p.fromAngle(this.rotation)}clone(){const t=new ct(this.position,this.velocity,this.mass);return t.rotation=this.rotation,t.angularVelocity=this.angularVelocity,t}}class ae{constructor(){this.planetRadius=35e4,this.surfaceGravity=9.81,this.atmosphereScaleHeight=7e3,this.surfaceDensity=1.2,this.maxDynamicPressure=5e4,this.earthRotationRate=72921159e-12,this.defaultDragCoefficient=.3,this.defaultCrossSectionalArea=10,this.gravitationalParameter=this.surfaceGravity*this.planetRadius*this.planetRadius}getSpeedOfSound(t){return t<=0?340:t<11e3?340-45*(t/11e3):295}getAltitude(t){return t-this.planetRadius}getAtmosphericDensity(t){return this.surfaceDensity*Math.exp(-t/this.atmosphereScaleHeight)}getGravitationalAcceleration(t){return this.gravitationalParameter/(t*t)}isBelowSurface(t){return t<this.planetRadius}isInSpace(t){return t>1e5}isInAtmosphere(t){return t<7e4}getCircularOrbitVelocity(t){const e=this.planetRadius+t;return Math.sqrt(this.gravitationalParameter/e)}getEscapeVelocity(t){const e=this.planetRadius+t;return Math.sqrt(2*this.gravitationalParameter/e)}}function re(g,t,e,s){const i=g.magnitude(),o=t.magnitude(),n=o*o/2-e/i;if(n>=0)return Number.POSITIVE_INFINITY;const a=-e/(2*n),r=g.cross(t),l=Math.sqrt(1+2*n*r*r/(e*e)),c=a*(1+l);return Math.max(0,c-s)}function le(g,t,e,s){const i=g.magnitude(),o=t.magnitude(),n=o*o/2-e/i;if(n>=0)return Number.NEGATIVE_INFINITY;const a=-e/(2*n),r=g.cross(t),l=Math.sqrt(1+2*n*r*r/(e*e));return a*(1-l)-s}function lt(g,t,e,s){const i=re(g,t,e,s),o=le(g,t,e,s);return{apoAlt:i,periAlt:o}}class ht{constructor(t,e=1e3,s=.3,i=10){this.stages=t.map(o=>({...o,fuelRemaining:o.propellantMass})),this.payloadMass=e,this.dragCoefficient=s,this.crossSectionalArea=i}getCurrentMass(){return this.stages.reduce((e,s)=>e+s.dryMass+s.fuelRemaining,0)+this.payloadMass}getThrustToWeightRatio(t){const e=this.getCurrentThrust(),s=this.getCurrentMass()*t;return s>0?e/s:0}getCurrentThrust(){return this.stages.filter(t=>t.isActive&&t.fuelRemaining>0).reduce((t,e)=>t+e.thrust,0)}getCurrentSpecificImpulse(){const t=this.stages.filter(i=>i.isActive&&i.fuelRemaining>0);if(t.length===0)return 0;const e=t.reduce((i,o)=>i+o.thrust,0);return e===0?0:t.reduce((i,o)=>i+o.specificImpulse*o.thrust/e,0)}getFuelConsumptionRate(t){return this.stages.filter(s=>s.isActive&&s.fuelRemaining>0).reduce((s,i)=>{const o=i.thrust*t,n=this.getEffectiveIsp(i,t),a=o/(n*9.81);return s+a},0)}consumeFuel(t,e){const s=this.stages.filter(o=>o.isActive&&o.fuelRemaining>0);if(s.length===0)return!1;let i=!1;for(const o of s){const n=o.thrust*e,a=this.getEffectiveIsp(o,e),l=n/(a*9.81)*t;o.fuelRemaining>0&&(o.fuelRemaining=Math.max(0,o.fuelRemaining-l),i=!0)}return i}getEffectiveIsp(t,e){const s=t.specificImpulse,o=.1*((1-Math.max(.1,Math.min(1,e)))/.9);return s*(1+Math.max(0,Math.min(.1,o)))}getActiveStage(){return this.stages.find(t=>t.isActive)||null}isReadyForStaging(){const t=this.getActiveStage();return t?t.fuelRemaining<=0:!1}performStaging(t=!1){const e=this.stages.findIndex(o=>o.isActive);if(e===-1||e>=this.stages.length-1)return!1;const s=this.stages[e];if(!s)return!1;s.isActive=!1;const i=this.stages[e+1];return i&&(i.isActive=!0),!0}isStagingSafe(t){return this.getActiveStage()?t===0:!1}isHotStaging(t){return t>0}wouldExplodeOnStaging(t){return t>0}getNextStage(){const t=this.stages.findIndex(e=>e.isActive);return t===-1||t>=this.stages.length-1?null:this.stages[t+1]||null}getCurrentStageIndex(){return this.stages.findIndex(t=>t.isActive)}shouldAutoStage(){const t=this.getActiveStage();return t?t.fuelRemaining<=0&&this.getNextStage()!==null:!1}getRemainingDeltaV(){let t=0,e=this.getCurrentMass();const s=this.getCurrentStageIndex()>=0?this.getCurrentStageIndex():0;for(let i=s;i<this.stages.length;i++){const o=this.stages[i],n=Math.max(0,o.fuelRemaining);if(n>0){const r=Math.max(1e-6,e-n);if(r>0&&r<e){const l=o.specificImpulse*9.81*Math.log(e/r);t+=Math.max(0,l),e=r}}i<this.stages.length-1&&(e=Math.max(1e-6,e-o.dryMass))}return t}static createTutorialRocket(){const t=[{name:"First Stage",thrust:48e4,specificImpulse:265,seaLevelIsp:265,vacuumIsp:300,propellantMass:2e4,dryMass:3e3,isActive:!0,fuelRemaining:2e4},{name:"Second Stage",thrust:12e4,specificImpulse:335,seaLevelIsp:300,vacuumIsp:335,propellantMass:5e3,dryMass:1200,isActive:!1,fuelRemaining:5e3}];return new ht(t,1e3)}}class ce{constructor(t){this.successSpacePlayed=!1,this.successOrbitPlayed=!1,this.isGameOver=!1,this.gameOverTimer=0,this.explosionPhase=!1,this.explosionTimer=0,this.gameOverReason="",this.context=t}initializeGameState(){const t=ht.createTutorialRocket(),e=new ae,s=new p(0,e.planetRadius),i=p.zero(),o=new ct(s,i,t.getCurrentMass());o.rotation=0;const n={isRunning:!1,isPaused:!1,timeWarp:1,currentTime:0,world:e,rocket:{position:s.clone(),velocity:i.clone(),rotation:0,mass:t.getCurrentMass(),fuel:t.stages.reduce((u,d)=>u+d.fuelRemaining,0),throttle:0,isEngineIgnited:!1,hasEverLaunched:!1,isClamped:!0,isOnGround:!0,currentStage:0,stages:t.stages},autopilotEnabled:!0},r=this.context.rocketRenderer.getRocketBounds(n.rocket).height/2,l=6,c=0;o.position=s.add(new p(0,r+l+c)),n.rocket.position=o.position.clone();const h=Math.atan2(o.position.y,o.position.x);return{gameState:n,rocketBody:o,rocketConfig:t,padBaseAngle:h}}resetState(){this.successSpacePlayed=!1,this.successOrbitPlayed=!1,this.isGameOver=!1,this.gameOverTimer=0,this.explosionPhase=!1,this.explosionTimer=0,this.gameOverReason=""}updateRocketState(t,e,s,i,o,n,a){t.rocket.position=e.position.clone(),t.rocket.velocity=e.velocity.clone(),t.rocket.rotation=e.rotation,t.rocket.visualRotation=i,t.rocket.mass=e.mass,t.rocket.stages=s.stages,t.autopilotRunning=o,t.rocket.dragCoefficient=n,t.rocket.crossSectionalArea=a,t.rocket.fuel=s.stages.reduce((r,l)=>r+l.fuelRemaining,0)}checkSuccessSounds(t){const e=t.world,s=t.rocket.position,i=t.rocket.velocity,o=e.getAltitude(s.magnitude());if(!this.successSpacePlayed&&o>=1e5&&(this.successSpacePlayed=!0,this.context.soundSystem.playSuccess()),!this.successOrbitPlayed){const n=e.gravitationalParameter,a=lt(s,i,n,e.planetRadius);Number.isFinite(a.periAlt)&&a.periAlt>8e4&&(this.successOrbitPlayed=!0,this.context.soundSystem.playSuccess())}}startExplosion(t){this.explosionPhase=!0,this.explosionTimer=0,this.gameOverReason=t,this.context.debugLog(`ðŸš€ðŸ’¥ ROCKET DESTROYED! ${t}`)}updateExplosion(t){return this.explosionPhase?(this.explosionTimer+=t,this.explosionTimer>=2?(this.explosionPhase=!1,this.isGameOver=!0,this.gameOverTimer=0,!1):!0):!1}updateGameOver(t){return this.isGameOver?(this.gameOverTimer+=t,{shouldRestart:!1}):{shouldRestart:!1}}renderGameOverScreen(){if(!this.isGameOver)return;const t=this.context.canvas.getContext("2d");if(!t)return;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),t.fillStyle="#ff4444",t.font="bold 48px monospace",t.textAlign="center",t.fillText("MISSION FAILED",this.context.canvas.width/2,this.context.canvas.height/2-40),t.fillStyle="#ffffff",t.font="24px monospace";const e=this.gameOverReason||"Vehicle destroyed";t.fillText(e,this.context.canvas.width/2,this.context.canvas.height/2+20);const s=80,i=30,o=this.context.canvas.width/2-s/2,n=this.context.canvas.height/2+60;this.menuButtonBounds={x:o,y:n,width:s,height:i},t.fillStyle="#aa2222",t.fillRect(o,n,s,i),t.strokeStyle="#ff6666",t.lineWidth=2,t.strokeRect(o,n,s,i),t.fillStyle="#ffffff",t.font="bold 16px monospace",t.textAlign="center",t.fillText("MENU",this.context.canvas.width/2,n+i/2+5),t.textAlign="left"}isExplosionPhase(){return this.explosionPhase}isGameOverState(){return this.isGameOver}getGameOverReason(){return this.gameOverReason}}function he(g,t){let e=(g.turnLeft?1:0)-(g.turnRight?1:0),s=g.apTargetRot;const i=[];if(g.apHold!=="none"){if(g.apHold==="up")s=0;else if(g.apHold==="prograde"||g.apHold==="retrograde"){const l=g.velocity,c=l.magnitude();let h=g.rotation;c>.5&&(h=Math.atan2(-l.x,l.y));const u=g.getAltitude(g.position.magnitude()),d=2e3,m=(u-d)/Math.max(1,15e3-d),f=Math.max(0,Math.min(1,m)),b=f*f*(3-2*f),S=0;let x=(g.apHold==="prograde"?h:h+Math.PI)-S;for(;x>Math.PI;)x-=2*Math.PI;for(;x<-Math.PI;)x+=2*Math.PI;s=S+x*b}if(s!==null){let l=s-g.rotation;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;e=l>.02?1:l<-.02?-1:0}}let o=g.angularVelocity+e*g.angularAccel*t;const n=g.maxTurnRate;o>n&&(o=n),o<-n&&(o=-n);const a=g.rotation+o*t;e===0&&(o*=.98,Math.abs(o)<1e-4&&(o=0));let r=g.lastDebugLogTime;if(g.debugEnabled){const l=g.currentTime;if(l-r>.1){const c=(a*180/Math.PI).toFixed(2),h=(o*180/Math.PI).toFixed(2);i.push(`ATT dt=${t.toFixed(3)} in=${e} rot=${c}Â° av=${h}Â°/s`),r=l}}return{rotation:a,angularVelocity:o,apTargetRot:s,lastDebugLogTime:r,debugMessages:i}}function de(g,t,e){const s=g;let o=t-s;for(;o>Math.PI;)o-=2*Math.PI;for(;o<-Math.PI;)o+=2*Math.PI;const n=1-Math.exp(-10*Math.max(0,e));return s+o*n}class ue{constructor(t,e,s,i,o){this.engine=t,this.canvas=e,this.camera=s,this.hud=i,this.state=o,this.onResize=()=>{this.engine.handleResize(),this.hud.handleResize()},this.onWheel=n=>{n.preventDefault();const a=n.deltaY>0?.9:1.1,r=this.camera.zoom,l=Math.max(5e-5,Math.min(3,r*a));this.camera.setZoom(l),this.state.manualZoomControl=!0},this.onKeyDown=n=>{const a=document.activeElement;if(!(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"))&&!this.engine.isAutopilotRunning())switch(n.code){case"Space":n.preventDefault(),this.state.rocket.isEngineIgnited||this.engine.igniteEngines();break;case"ArrowUp":n.preventDefault(),this.engine.nudgeThrottle?.(.1);break;case"ArrowDown":n.preventDefault(),this.engine.nudgeThrottle?.(-.1);break;case"KeyT":this.engine.setThrottle(1);break;case"KeyG":this.engine.setThrottle(0);break;case"KeyB":this.engine.cutEngines();break;case"ArrowLeft":this.engine.setTurnLeft(!0);break;case"ArrowRight":this.engine.setTurnRight(!0);break;case"KeyS":this.engine.performStaging();break;case"KeyP":this.engine.togglePause();break}},this.onKeyUp=n=>{const a=document.activeElement;if(!(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"))&&!this.engine.isAutopilotRunning())switch(n.code){case"ArrowLeft":this.engine.setTurnLeft(!1);break;case"ArrowRight":this.engine.setTurnRight(!1);break}},this.onClick=n=>{const a=this.canvas.getBoundingClientRect(),r=window.devicePixelRatio||1,l=(n.clientX-a.left)*r,c=(n.clientY-a.top)*r,h=this.hud,u=this.engine.getMenuButtonBounds?.();if(u){const d=u;if(l>=d.x&&l<=d.x+d.width&&c>=d.y&&c<=d.y+d.height){this.engine.goToMenu(this.engine.isAutopilotOn?.()??!1);return}}if(h.restartButtonBounds){const d=h.restartButtonBounds;if(l>=d.x&&l<=d.x+d.width&&c>=d.y&&c<=d.y+d.height){this.engine.goToMenu(this.engine.isAutopilotOn?.()??!1);return}}}}init(){document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),window.addEventListener("resize",this.onResize),this.canvas.addEventListener("wheel",this.onWheel,{passive:!1}),this.canvas.addEventListener("click",this.onClick),this.setupSpeedControls()}setupSpeedControls(){const t=document.querySelectorAll(".speed-btn");for(const e of t)e.addEventListener("click",s=>{const i=s.target,o=Number.parseInt(i.dataset.speed||"1"),n=this.state.world.getAltitude(this.state.rocket.position.magnitude());let a=0;if(o>=3&&o<10&&(a=500),o>=10&&o<50&&(a=1e3),o>=50&&(a=3e4),n<a){const r=a>=1e3?`${(a/1e3).toFixed(a%1e3===0?0:1)} km`:`${a} m`;this.engine.showInfo(`Wait for >${r} for x${o}`,2.5);return}this.engine.setGameSpeed(o)})}}class ge{constructor(t){this.context=t}updateContext(t){Object.assign(this.context,t)}updatePhysics(t){const{gameState:e,rocketBody:s,rocketConfig:i,world:o,padBaseAngle:n,soundSystem:a}=this.context;if(!e.rocket.hasEverLaunched||e.rocket.isClamped)return this.keepRocketOnPad(),{aeroCdEff:this.context.aeroCdEff,aeroAreaEff:this.context.aeroAreaEff,lastMach:this.context.lastMach,lastAoADeg:this.context.lastAoADeg};if(this.shouldStayGrounded())return this.keepRocketGrounded(),{aeroCdEff:this.context.aeroCdEff,aeroAreaEff:this.context.aeroAreaEff,lastMach:this.context.lastMach,lastAoADeg:this.context.lastAoADeg};s.clearForces();const r=this.calculateGravityForce();if(s.applyForce(r),e.rocket.isEngineIgnited&&e.rocket.throttle>0){const c=this.calculateThrustForce();s.applyForce(c),(!i.consumeFuel(t,e.rocket.throttle)||i.getCurrentThrust()===0)&&(e.rocket.isEngineIgnited=!1,e.rocket.throttle=0,a.stopEngine())}if(o.getAltitude(s.position.magnitude())<8e4){const c=this.calculateDragForce();s.applyForce(c.force),this.context.aeroCdEff=c.cdEff,this.context.aeroAreaEff=c.areaEff,this.context.lastMach=c.mach,this.context.lastAoADeg=c.aoaDeg}return s.setMass(i.getCurrentMass()),s.integrate(t),o.isBelowSurface(s.position.magnitude())&&this.handleGroundCollision(),{aeroCdEff:this.context.aeroCdEff,aeroAreaEff:this.context.aeroAreaEff,lastMach:this.context.lastMach,lastAoADeg:this.context.lastAoADeg}}keepRocketOnPad(){const{gameState:t,rocketBody:e,world:s,padBaseAngle:i}=this.context,n=this.context.getRocketBounds().height/2,r=s.planetRadius+n+6,l=s.earthRotationRate||0,c=i+t.currentTime*l,h=Math.cos(c)*r,u=Math.sin(c)*r,d=new p(h,u),y=new p(-Math.sin(c),Math.cos(c)).multiply(l*r);e.position=d,e.velocity=y}shouldStayGrounded(){const{rocketBody:t,world:e,rocketConfig:s,gameState:i}=this.context,n=this.context.getRocketBounds().height/2,a=6,r=t.position.magnitude();if(r-(e.planetRadius+n+a)<=1.5){const c=e.getGravitationalAcceleration(r),h=t.mass*c,u=s.getCurrentThrust()*i.rocket.throttle;return(h>0?u/h:0)<=1.01}return!1}keepRocketGrounded(){const{gameState:t,rocketBody:e,world:s,padBaseAngle:i}=this.context,n=this.context.getRocketBounds().height/2,r=s.planetRadius+n+6+1,l=s.earthRotationRate||0,c=i+t.currentTime*l,h=new p(Math.cos(c)*r,Math.sin(c)*r),u=new p(-Math.sin(c),Math.cos(c)).multiply(l*r);e.position=h,e.velocity=u,t.rocket.isOnGround=!0}calculateGravityForce(){const{rocketBody:t,world:e}=this.context,s=t.position,i=s.magnitude(),o=e.getGravitationalAcceleration(i);return this.safeNormalize(s).multiply(-1).multiply(o*t.mass)}calculateThrustForce(){const{rocketBody:t,rocketConfig:e,gameState:s}=this.context,i=e.getCurrentThrust()*s.rocket.throttle;return new p(-Math.sin(t.rotation),Math.cos(t.rotation)).multiply(i)}calculateDragForce(){const{rocketBody:t,world:e,rocketConfig:s}=this.context,i=e.getAltitude(t.position.magnitude());if(i>=8e4)return{force:p.zero(),cdEff:s.dragCoefficient,areaEff:s.crossSectionalArea,mach:0,aoaDeg:0};const o=e.getAtmosphericDensity(i),n=t.velocity.subtract(this.getGroundVelocityAt(t.position)),a=n.magnitude();if(a<.01||o<=0)return{force:p.zero(),cdEff:s.dragCoefficient,areaEff:s.crossSectionalArea,mach:0,aoaDeg:0};const r=new p(-Math.sin(t.rotation),Math.cos(t.rotation)),l=n.multiply(-1/a),c=Math.max(-1,Math.min(1,r.x*l.x+r.y*l.y)),h=Math.acos(c),u=e.getSpeedOfSound(i),d=a/Math.max(1,u),y=s.crossSectionalArea,m=6,f=Math.sin(h)*Math.sin(h),b=1-f,S=y*(b+m*f),M=s.dragCoefficient,x=1+4*f;let v=1;if(d>=.8&&d<=1.2){const C=1-Math.abs(d-1)/.4;v=1+1.5*Math.max(0,C)}else d>1.2&&(v=1.1+.1*Math.min(1,(d-1.2)/1.8));const A=M*x*v;return{force:te(n,o,A,S),cdEff:A,areaEff:S,mach:d,aoaDeg:h*180/Math.PI}}handleGroundCollision(){const{rocketBody:t,world:e,effectsSystem:s,soundSystem:i,debugLog:o}=this.context;o("Ground collision detected!");const n=this.getGroundVelocityAt(t.position),a=t.velocity.subtract(n).magnitude();if(a>15){o(`ðŸ’¥ HIGH-SPEED GROUND IMPACT! Speed: ${a.toFixed(1)} m/s - EXPLOSION!`),s.createExplosion(this.context.gameState.rocket.position,this.context.gameState.rocket.velocity),i.playExplosion(),this.context.destroyRocket("High-speed ground impact");return}o(`Soft landing! Impact speed: ${a.toFixed(1)} m/s`),t.velocity=p.zero();const r=t.position.magnitude(),l=e.planetRadius,h=this.context.getRocketBounds().height/2,u=l+h+1;if(r<u){const d=this.safeNormalize(t.position);t.position=d.multiply(u)}}getGroundVelocityAt(t){const{world:e}=this.context,s=e.earthRotationRate||0,i=t.magnitude();if(i<1e-6||s===0)return p.zero();const o=this.safeNormalize(t);return new p(-o.y,o.x).multiply(s*i)}safeNormalize(t){const e=t.magnitude();if(e<.001)return new p(0,-1);try{return t.normalized()}catch{return new p(t.x/e,t.y/e)}}}class fe{constructor(t=!0){this.audioContext=null,this.engineSource=null,this.engineGain=null,this.engineLoopBuffer=null,this.engineStartBuffer=null,this.isEngineRunning=!1,this.enabled=!0,this.enabled=t}async initAudio(){if(!this.audioContext)try{const t=window.AudioContext||window.webkitAudioContext;if(!t){console.warn("Web Audio API not supported"),this.enabled=!1;return}this.audioContext=new t,this.engineStartBuffer=await this.loadSound("sounds/rocket-launch-306441.mp3"),this.engineLoopBuffer=await this.loadSound("sounds/fx-looking-straight-into-a-burning-rocket-engine-283448.mp3")}catch(t){console.warn("Failed to initialize audio:",t),this.enabled=!1}}async loadSound(t){if(!this.audioContext||!this.enabled)return null;try{const s=await(await fetch(t)).arrayBuffer();return await this.audioContext.decodeAudioData(s)}catch(e){return console.warn(`Failed to load sound ${t}:`,e),null}}async ensureContext(){if(!this.audioContext||!this.enabled)return!1;if(this.audioContext.state==="suspended")try{await this.audioContext.resume()}catch(t){return console.warn("Failed to resume audio context:",t),!1}return!0}async playGameStart(){if(await this.initAudio(),!!await this.ensureContext())try{const t=await this.loadSound("sounds/game-start-6104.mp3");if(!t||!this.audioContext)return;const e=this.audioContext.createBufferSource(),s=this.audioContext.createGain();e.buffer=t,s.gain.value=.5,e.connect(s),s.connect(this.audioContext.destination),e.start()}catch(t){console.warn("Failed to play game start sound:",t)}}async playEngineIgnite(){if(await this.initAudio(),!!await this.ensureContext())try{if(!this.engineStartBuffer||!this.audioContext)return;const t=this.audioContext.createBufferSource(),e=this.audioContext.createGain();t.buffer=this.engineStartBuffer,e.gain.value=.6,t.connect(e),e.connect(this.audioContext.destination),t.start(),setTimeout(()=>this.startEngineLoop(.5),500)}catch(t){console.warn("Failed to play engine ignite sound:",t)}}async startEngineLoop(t=.5){if(await this.ensureContext()&&!(this.isEngineRunning||!this.engineLoopBuffer||!this.audioContext))try{this.engineSource=this.audioContext.createBufferSource(),this.engineGain=this.audioContext.createGain(),this.engineSource.buffer=this.engineLoopBuffer,this.engineSource.loop=!0,this.engineGain.gain.value=t*.7,this.engineSource.connect(this.engineGain),this.engineGain.connect(this.audioContext.destination),this.engineSource.start(),this.isEngineRunning=!0}catch(e){console.warn("Failed to start engine loop sound:",e)}}setEngineThrottle(t){if(!(!this.engineGain||!this.isEngineRunning||!this.audioContext))try{const e=Math.max(0,Math.min(1,t))*.7;this.engineGain.gain.linearRampToValueAtTime(e,this.audioContext.currentTime+.1)}catch(e){console.warn("Failed to set engine throttle:",e)}}stopEngine(){if(!(!this.isEngineRunning||!this.engineSource))try{this.engineSource.stop(),this.engineSource.disconnect(),this.engineGain&&this.engineGain.disconnect()}catch(t){console.warn("Failed to stop engine:",t)}finally{this.engineSource=null,this.engineGain=null,this.isEngineRunning=!1}}async playExplosion(){if(await this.ensureContext())try{const t=await this.loadSound("sounds/nuclear-explosion-386181.mp3");if(!t||!this.audioContext)return;const e=this.audioContext.createBufferSource(),s=this.audioContext.createGain();e.buffer=t,s.gain.value=.6,e.connect(s),s.connect(this.audioContext.destination),e.start(),this.stopEngine()}catch(t){console.warn("Failed to play explosion sound:",t)}}async playSuccess(){if(await this.ensureContext())try{const t=await this.loadSound("sounds/success-340660.mp3");if(!t||!this.audioContext)return;const e=this.audioContext.createBufferSource(),s=this.audioContext.createGain();e.buffer=t,s.gain.value=.6,e.connect(s),s.connect(this.audioContext.destination),e.start()}catch(t){console.warn("Failed to play success sound:",t)}}setEnabled(t){this.enabled=t,t||this.stopEngine()}dispose(){if(this.stopEngine(),this.audioContext){try{this.audioContext.close()}catch(t){console.warn("Failed to close audio context:",t)}this.audioContext=null}}}class pe{constructor(){this.separatedStages=[],this.lastStagingTime=0,this.stagingVis=new J}reset(){this.separatedStages=[],this.stagingVis=new J,this.lastStagingTime=0}createStagingAnimation(t,e,s,i){this.lastStagingTime=t.currentTime;const o=t.rocket.position,n=t.rocket.velocity,a=t.rocket.currentStage-1,r=n.add(e.multiply(5));let l;typeof s=="number"?l=Math.max(10,-s):l=Math.max(10,i/2);const c=o.add(e.multiply(l)),h=20+Math.random()*5,u=c.add(e.multiply(h));this.separatedStages.push({pos:u,vel:r,rotation:t.rocket.rotation,rotSpeed:0,life:30,stageIndex:Math.max(0,a),bornTime:t.currentTime,age:0,landed:!1});for(let d=0;d<4;d++){const y=d/4*Math.PI*2,m=10+Math.random()*20,f=new p(n.x+Math.cos(y)*m,n.y+Math.sin(y)*m);this.stagingVis.addDebris(o,f,Math.random()*Math.PI*2,(Math.random()-.5)*10,2)}}update(t,e,s,i){for(let o=this.separatedStages.length-1;o>=0;o--){const n=this.separatedStages[o];if(n.landed){n.life-=t*0,n.life<=0&&this.separatedStages.splice(o,1);continue}n.age+=t;const a=e.getGravitationalAcceleration(n.pos.magnitude()),r=n.pos.magnitude();let l;r<.001?l=new p(0,-1):l=n.pos.multiply(-1/r);const c=l.multiply(a);if(n.vel=n.vel.add(c.multiply(t)),e.getAltitude(n.pos.magnitude())<=0){if(n.vel.magnitude()>15){i(n.pos,n.vel),this.separatedStages.splice(o,1);continue}const m=r>.001?n.pos.multiply(1/r):new p(0,1);n.pos=m.multiply(e.planetRadius+1),n.vel=p.zero(),n.landed=!0}n.landed||(n.pos=n.pos.add(n.vel.multiply(t))),n.life-=t;const u=s.worldToScreen(n.pos),d=s.getSize();!n.landed&&u.y>d.y+120&&(n.life=0),n.life<=0&&this.separatedStages.splice(o,1)}this.stagingVis.update(t)}render(t){for(const e of this.separatedStages){const s=Math.max(0,Math.min(1,e.life/30));t.drawRotated(e.pos,e.rotation,()=>{e.stageIndex===0?t.drawRectangle(new p(-8,-25),16,50,`rgba(240, 240, 240, ${s})`,`rgba(44, 90, 160, ${s})`,2):t.drawRectangle(new p(-6,-18),12,36,`rgba(255, 255, 255, ${s})`,`rgba(192, 57, 43, ${s})`,2)})}}getStagingAnimationTime(t){return t-this.lastStagingTime}}class me{constructor(t){this.isRunning=!1,this.lastTime=0,this.animationFrameId=0,this.gameStartTime=0,this.missionTimer=0,this.gameSpeed=2,this.showHUD=!0,this.padBaseAngle=Math.PI/2,this.autopilotEnabled=!1,this.pendingAutopilotMode=null,this.apHold="none",this.apTargetRot=null,this.apLogger=null,this.aeroCdEff=.3,this.aeroAreaEff=10,this.lastMach=0,this.lastAoADeg=0,this.overspeedTime=0,this.turnLeft=!1,this.turnRight=!1,this.angularVelocity=0,this.maxTurnRate=.12,this.angularAccel=.5,this.visualRotation=0,this.debugEnabled=!1,this.lastDebugLogTime=0,this.lastSoundDensity=-1,this.canvas=t,this.renderer=new Xt(t),this.camera=new Ut(p.zero(),.1),this.hudSystem=new ee(t),this.rocketRenderer=new Zt,this.physicsIntegrator=new rt,this.autopilot=new ie(this),this.background=new qt,this.planetRenderer=new Kt,this.stageManager=new pe,this.effectsSystem=new ne,this.soundSystem=new fe(!0),this.stateManager=new ce({canvas:this.canvas,rocketRenderer:this.rocketRenderer,soundSystem:this.soundSystem,debugLog:(...e)=>this.debugLog(...e)}),this.renderer.setCamera(this.camera),this.initializeGameState(),this.camera.setTarget(this.gameState.rocket.position),this.camera.position=this.gameState.rocket.position.clone(),this.camera.setZoom(.8),this.gameStartTime=Date.now(),this.missionTimer=0,this.atmosphereUI=new Qt(this.canvas),this.atmosphereUI.addMessage("Good luck!",0,3),this.setupEventListeners(),this.factSystem=new Jt(this.canvas),this.gameState.autopilotEnabled=!1}debugLog(...t){this.debugEnabled&&[...t]}safeNormalize(t){const e=t.magnitude();if(e<.001)return new p(0,-1);try{return t.normalized()}catch{return new p(t.x/e,t.y/e)}}toggleAutopilot(){this.autopilotEnabled=!this.autopilotEnabled,this.gameState.autopilotEnabled=this.autopilotEnabled,document.dispatchEvent(new CustomEvent("autopilot-toggle",{detail:{enabled:this.autopilotEnabled}}))}showInfo(t,e=2.5){this.atmosphereUI.addMessage(t,this.gameState.currentTime,e)}isAutopilotOn(){return this.autopilotEnabled}getApoapsisAltitude(){const t=this.gameState.world.gravitationalParameter,e=this.gameState.world.planetRadius,s=lt(this.gameState.rocket.position,this.gameState.rocket.velocity,t,e);return Number.isFinite(s.apoAlt)?s.apoAlt:Number.POSITIVE_INFINITY}getPeriapsisAltitude(){const t=this.gameState.world.gravitationalParameter,e=this.gameState.world.planetRadius;return lt(this.gameState.rocket.position,this.gameState.rocket.velocity,t,e).periAlt}getRadialVelocity(){const t=this.gameState.rocket.position,e=this.gameState.rocket.velocity,s=Math.hypot(t.x,t.y);if(s<1e-6)return 0;const i=t.x/s,o=t.y/s;return e.x*i+e.y*o}getAltitude(){return this.gameState.world.getAltitude(this.gameState.rocket.position.magnitude())}getActiveStageFuel(){try{const t=this.rocketConfig.getCurrentStageIndex(),e=this.rocketConfig.stages[t];return typeof e?.fuelRemaining=="number"?e.fuelRemaining:Number.NaN}catch{return Number.NaN}}checkSuccessSounds(){this.stateManager.checkSuccessSounds(this.gameState)}initializeGameState(){const t=this.stateManager.initializeGameState();this.gameState=t.gameState,this.rocketBody=t.rocketBody,this.rocketConfig=t.rocketConfig,this.padBaseAngle=t.padBaseAngle,this.physicsSimulation=new ge({world:this.gameState.world,rocketConfig:this.rocketConfig,rocketBody:this.rocketBody,gameState:this.gameState,effectsSystem:this.effectsSystem,soundSystem:this.soundSystem,padBaseAngle:this.padBaseAngle,aeroCdEff:this.aeroCdEff,aeroAreaEff:this.aeroAreaEff,lastMach:this.lastMach,lastAoADeg:this.lastAoADeg,debugLog:(...e)=>this.debugLog(...e),getRocketBounds:()=>this.rocketRenderer.getRocketBounds(this.gameState.rocket),destroyRocket:e=>this.destroyRocket(e)}),this.commandExecutor=new oe({gameState:this.gameState,rocketBody:this.rocketBody,rocketConfig:this.rocketConfig,soundSystem:this.soundSystem,effectsSystem:this.effectsSystem,stageManager:this.stageManager,rocketRenderer:this.rocketRenderer,debugLog:(...e)=>this.debugLog(...e),destroyRocket:e=>this.destroyRocket(e)})}setupEventListeners(){new ue(this,this.canvas,this.camera,this.hudSystem,this.gameState).init()}async initialize(){this.debugLog("Game engine initialized")}start(){this.isRunning||(this.isRunning=!0,this.gameState.isRunning=!0,this.lastTime=performance.now(),this.soundSystem.playGameStart(),this.gameLoop(),this.debugLog("Game started"))}nudgeThrottle(t){this.commandExecutor.nudgeThrottle(t)}setTurnLeft(t){this.turnLeft=t}setTurnRight(t){this.turnRight=t}isAutopilotRunning(){return!!this.autopilot?.isRunning()}handleResize(){this.renderer.handleResize()}pause(){this.gameState.isPaused=!0,this.debugLog("Game paused")}stop(){this.isRunning=!1,this.gameState.isPaused=!0,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0)}resume(){this.gameState.isPaused=!1,this.debugLog("Game resumed")}restart(){this.debugLog("ðŸ”„ Restarting game..."),this.stop(),this.stateManager.resetState(),this.overspeedTime=0,this.stageManager.reset(),this.effectsSystem.reset(),this.atmosphereUI.reset(),this.initializeGameState(),this.pendingAutopilotMode!==null&&(this.autopilotEnabled=this.pendingAutopilotMode,this.gameState.autopilotEnabled=this.pendingAutopilotMode,document.dispatchEvent(new CustomEvent("autopilot-toggle",{detail:{enabled:this.autopilotEnabled}})),this.pendingAutopilotMode=null),this.gameStartTime=Date.now(),this.missionTimer=0,this.start(),this.debugLog("âœ… Game restarted successfully!")}goToMenu(t){try{typeof t=="boolean"&&localStorage.setItem("startAutoPilot",t?"1":"0")}catch{}window.location.reload()}togglePause(){this.gameState.isPaused?this.resume():this.pause()}reset(){this.isRunning=!1,this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.initializeGameState(),this.debugLog("Game reset")}gameLoop(){if(!this.isRunning)return;const t=performance.now(),e=Math.min((t-this.lastTime)/1e3,.1);this.lastTime=t,this.gameState.isPaused||this.update(e*this.gameState.timeWarp*this.gameSpeed),this.render(),this.animationFrameId=requestAnimationFrame(()=>this.gameLoop())}update(t){if(this.stateManager.isExplosionPhase()){this.stateManager.updateExplosion(t),this.effectsSystem.update(t),this.stageManager.update(t,this.gameState.world,this.renderer,(h,u)=>this.effectsSystem.createExplosion(h,u));return}if(this.stateManager.isGameOverState()){this.stateManager.updateGameOver(t).shouldRestart&&this.goToMenu(this.autopilotEnabled),this.effectsSystem.update(t),this.stageManager.update(t,this.gameState.world,this.renderer,(u,d)=>this.effectsSystem.createExplosion(u,d));return}this.gameState.currentTime+=t,this.missionTimer+=t;{const h=he({turnLeft:this.turnLeft,turnRight:this.turnRight,apHold:this.apHold,apTargetRot:this.apTargetRot,angularVelocity:this.angularVelocity,angularAccel:this.angularAccel,maxTurnRate:this.maxTurnRate,debugEnabled:this.debugEnabled,lastDebugLogTime:this.lastDebugLogTime,currentTime:this.gameState.currentTime,rotation:this.rocketBody.rotation,velocity:this.rocketBody.velocity,position:this.rocketBody.position,getAltitude:u=>this.gameState.world.getAltitude(u)},t);if(this.rocketBody.rotation=h.rotation,this.angularVelocity=h.angularVelocity,this.apTargetRot=h.apTargetRot,this.lastDebugLogTime=h.lastDebugLogTime,h.debugMessages?.length)for(const u of h.debugMessages)this.debugLog(u)}this.physicsIntegrator.update(t,h=>{this.updatePhysics(h)}),this.autopilot?.update(t),this.background.update(this.gameState,t),this.stageManager.update(t,this.gameState.world,this.renderer,(h,u)=>this.effectsSystem.createExplosion(h,u)),this.effectsSystem.update(t),this.atmosphereUI.checkLayers(this.gameState.world,this.gameState.rocket.position.magnitude(),this.gameState.currentTime),this.atmosphereUI.update(this.gameState.currentTime);const e=this.gameState.rocket.rotation,s=new p(Math.sin(e),-Math.cos(e)),i=this.gameState.rocket.exhaustY;let o;if(typeof i=="number")o=Math.max(10,-i);else{const h=this.rocketRenderer.getRocketBounds(this.gameState.rocket);o=Math.max(10,h.height/2)}this.effectsSystem.updateSpeedEffects(t,this.gameState,this.gameState.world,s,o);const n=this.gameState.rocket.position.add(s.multiply(o));this.effectsSystem.createEngineSmoke(this.gameState,this.gameState.world,s,n),this.enforceAtmosphericLimits(t);const a=this.gameState.world.getAltitude(this.gameState.rocket.position.magnitude()),r=this.gameState.world.getAtmosphericDensity(Math.max(0,a));Math.max(0,Math.min(1,r/this.gameState.world.surfaceDensity)),this.updateRocketState(),this.visualRotation=de(this.visualRotation,this.rocketBody.rotation,t),this.camera.position=this.gameState.rocket.position.clone();const l=this.gameState.world.getAltitude(this.gameState.rocket.position.magnitude()),c=l>2e5;!this.gameState.manualZoomControl&&!c&&l<5e4&&this.camera.setZoom(.75),this.factSystem?.update(Date.now(),this.gameState.world.getAltitude(this.gameState.rocket.position.magnitude())),this.checkSuccessSounds()}setAutopilotHold(t){this.apHold=t}setAutopilotTargetAngle(t){const e=t*Math.PI/180;this.apTargetRot=e,this.apHold="target"}isEngineOn(){return this.gameState.rocket.isEngineIgnited}isOnGround(){try{const e=this.rocketRenderer.getRocketBounds(this.gameState.rocket).height/2;if(this.rocketBody.position.magnitude()-(this.gameState.world.planetRadius+e+6)<=1.5)return!0}catch{}return this.gameState.rocket.isClamped===!0||this.gameState.rocket.isOnGround===!0||this.gameState.rocket.hasEverLaunched===!1}getCurrentTWR(){const t=this.gameState.world.getGravitationalAcceleration(this.rocketBody.position.magnitude()),e=this.rocketConfig.getCurrentThrust()*this.gameState.rocket.throttle,s=this.rocketBody.mass*t;return s>0?e/s:0}setAutopilotLogger(t){this.apLogger=t,this.autopilot?.setLogger(e=>{this.apLogger&&this.apLogger(e)})}runAutopilotScript(t){this.autopilot&&this.autopilot.runScript(t)}runAutopilotCommand(t){this.autopilot&&this.autopilot.runCommand(t)}stopAutopilot(){this.autopilot?.stop()}setGameSpeed(t){const s={1:2,3:4,10:10,50:50}[t]||2;this.gameSpeed=s;try{document.dispatchEvent(new CustomEvent("game-speed-change",{detail:{speed:t}}))}catch{}}enforceAtmosphericLimits(t){const e=se({world:this.gameState.world,position:this.rocketBody.position,velocity:this.rocketBody.velocity,mass:this.rocketBody.mass,aeroCdEff:this.aeroCdEff,aeroAreaEff:this.aeroAreaEff,heatLevel:this.effectsSystem.getHeatLevel(),atmosphericGlow:this.effectsSystem.getAtmosphericGlow(),hasBurnedUp:this.effectsSystem.hasBurnedUpStatus(),isGameOver:this.stateManager.isGameOverState(),currentTime:this.gameState.currentTime,overspeedTime:this.overspeedTime},t);this.rocketBody.velocity=e.velocity,this.gameState.rocket.velocity=e.velocity.clone(),this.effectsSystem.setHeatLevel(e.heatLevel),this.effectsSystem.setAtmosphericGlow(e.atmosphericGlow),this.effectsSystem.setHasBurnedUp(e.hasBurnedUp),this.overspeedTime=e.overspeedTime||0,e.explode&&(this.effectsSystem.createExplosion(this.gameState.rocket.position,this.gameState.rocket.velocity),this.soundSystem.playExplosion()),e.destroy&&this.destroyRocket(e.gameOverReason||"Vehicle destroyed")}updatePhysics(t){this.physicsSimulation.updateContext({gameState:this.gameState,rocketBody:this.rocketBody,rocketConfig:this.rocketConfig,padBaseAngle:this.padBaseAngle});const e=this.physicsSimulation.updatePhysics(t);this.aeroCdEff=e.aeroCdEff,this.aeroAreaEff=e.aeroAreaEff,this.lastMach=e.lastMach,this.lastAoADeg=e.lastAoADeg}updateRocketState(){this.stateManager.updateRocketState(this.gameState,this.rocketBody,this.rocketConfig,this.visualRotation,this.isAutopilotRunning(),this.aeroCdEff,this.aeroAreaEff)}render(){try{const t=Math.atan2(this.gameState.rocket.position.y,this.gameState.rocket.position.x);this.camera.setRotation(t-Math.PI/2)}catch{}if(this.renderer.clear(),this.renderer.beginFrame(),this.planetRenderer.render(this.renderer,this.gameState.world,this.gameState.currentTime,this.gameState.rocket.position,this.padBaseAngle),this.background.render(this.renderer,this.gameState),this.effectsSystem.render(this.renderer,this.gameState.rocket),this.stageManager.render(this.renderer),!this.stateManager.isExplosionPhase()&&!this.stateManager.isGameOverState()&&this.rocketRenderer.render(this.renderer,this.gameState.rocket),this.effectsSystem.renderFront(this.renderer),this.camera.zoom<.01){const t=this.gameState.currentTime,s=.25+.45*(.5+.5*Math.sin(2*Math.PI*1.2*t)),o=3/Math.max(1e-6,this.camera.zoom),n=`rgba(255, 40, 40, ${s.toFixed(3)})`;this.renderer.drawCircle(this.gameState.rocket.position,o,n)}this.renderer.endFrame(),this.showHUD&&(this.hudSystem.render(this.renderer,this.gameState,this.missionTimer),this.factSystem?.render(),this.atmosphereUI.render(this.gameState.currentTime)),this.stateManager.isGameOverState()&&this.renderGameOverScreen()}igniteEngines(){return this.commandExecutor.igniteEngines()}setThrottle(t){this.commandExecutor.setThrottle(t)}cutEngines(){this.commandExecutor.cutEngines()}performStaging(){return this.commandExecutor.performStaging()}destroyRocket(t){this.stateManager.startExplosion(t||"Vehicle destroyed"),this.gameState.rocket.isEngineIgnited=!1,this.gameState.rocket.throttle=0,this.soundSystem.stopEngine(),this.effectsSystem.createDestructionDebris(this.gameState.rocket.position,this.gameState.rocket.velocity)}renderGameOverScreen(){this.stateManager.renderGameOverScreen()}getMenuButtonBounds(){return this.stateManager.menuButtonBounds}}function ye(g){const t=document.createElement("div");t.id="ap-panel",t.style.marginTop="8px",t.style.padding="8px 10px",t.style.background="rgba(15,15,22,0.9)",t.style.border="1px solid #445",t.style.borderRadius="6px",t.style.color="#ddd",t.style.display="none";const e=document.createElement("div");e.style.display="grid",e.style.gridTemplateColumns="1fr auto 1fr",e.style.alignItems="center",e.style.minHeight="26px",e.style.marginBottom="6px";const s=document.createElement("div");s.textContent="Command Console - Run your own scripts or try the Auto Pilot!",s.style.fontSize="13px",s.style.color="#9ecbff",s.style.justifySelf="start",e.appendChild(s);const i=document.createElement("button");i.textContent="AUTO PILOT",i.style.justifySelf="center",i.style.marginTop="3px",i.style.background="linear-gradient(145deg, #255a8a, #1d3f63)",i.style.border="1px solid #3e77a8",i.style.color="#e3f2fd",i.style.fontSize="12px",i.style.padding="5px 12px",i.style.borderRadius="5px",i.style.cursor="pointer",i.style.opacity="0.95",e.appendChild(i);const o=(m,f)=>{m&&!f?(i.style.background="linear-gradient(145deg, #255a8a, #1d3f63)",i.style.border="1px solid #3e77a8",i.style.color="#e3f2fd",i.style.cursor="pointer",i.style.opacity="0.95"):(i.style.background="#3a3a3a",i.style.border="1px solid #555",i.style.color="#aaaaaa",i.style.cursor="not-allowed",i.style.opacity="0.6")},n=()=>{try{const m=g.isOnGround(),f=g.isAutopilotRunning();i.disabled=f||!m,i.textContent=f?"RUNNING":"AUTO PILOT",i.title=f?"Autopilot running":m?"Click to auto-run the launch script":"Available only while on the ground",o(!i.disabled,f)}catch{}};i.addEventListener("click",()=>{if(i.disabled)return;const m=["ignite","hold up","throttle 1","wait until altitude 800","pitch east 5","wait until altitude 6000","pitch east 15","wait until altitude 15000","pitch east 35","wait until altitude 40000","pitch east 55","wait until stage empty","throttle 0","cut","stage","hold prograde","wait until apoapsis","ignite","throttle 1","until periapsis = 110000","cut"].join(`
`);g.runAutopilotScript(m)}),n();const a=window.setInterval(n,400);window.addEventListener("beforeunload",()=>window.clearInterval(a)),t.appendChild(e);const r=document.createElement("div");r.id="ap-log",r.style.height="100px",r.style.overflowY="auto",r.style.background="rgba(0,0,0,0.35)",r.style.border="1px solid #334",r.style.padding="6px",r.style.marginBottom="6px",t.appendChild(r);const l=m=>{const f=document.createElement("div");f.textContent=m,f.style.whiteSpace="pre-wrap",/^ERR:/i.test(m)&&(f.style.color="#ff6666"),r.appendChild(f),r.scrollTop=r.scrollHeight};g.setAutopilotLogger(l);const c=document.createElement("div");c.style.display="flex",c.style.gap="6px";const h=document.createElement("textarea");h.id="ap-input",h.placeholder=["Type commands then Run. Examples:","ignite //// hold prograde","throttle 0.6 //// wait 10","until apoapsis 120000 then throttle 0.3","cut"].join(`
`),h.style.flex="1",h.style.height="80px",h.style.resize="none",h.style.fontFamily="Courier New, monospace",h.style.fontSize="12px",h.style.color="#eee",h.style.background="rgba(0,0,0,0.5)",h.style.border="1px solid #334",h.style.padding="6px",c.appendChild(h);const u=document.createElement("button");u.textContent="Run",u.style.minWidth="80px",u.style.background="#1b5e20",u.style.color="#e8ffe8",u.style.border="1px solid #2e7d32",u.style.borderRadius="4px",u.style.padding="6px 10px",u.onclick=()=>{const m=h.value;m.trim()&&(l("> run"),g.runAutopilotScript(m),h.value="",h.focus())},c.appendChild(u);const d=document.createElement("button");d.textContent="Stop",d.style.minWidth="80px",d.style.background="#7a1f1f",d.style.color="#ffeaea",d.style.border="1px solid #c62828",d.style.borderRadius="4px",d.style.padding="6px 10px",d.onclick=()=>{g.stopAutopilot(),g.cutEngines(),l("> stopped (engines cut)")},c.appendChild(d),t.appendChild(c),document.addEventListener("prefill-autopilot-script",()=>{const m=["ignite","hold up","throttle 1","wait until altitude 1000","pitch east 5","wait until altitude 6000","pitch east 15","wait until altitude 15000","pitch east 35","wait until altitude 40000","pitch east 55","wait until stage empty","throttle 0","cut","stage","hold prograde","wait until apoapsis","ignite","throttle 1","until periapsis = 110000","cut"].join(`
`);h.value=m,h.focus()}),document.querySelector(".control-panel")?.appendChild(t),t.style.display="block"}const At="settings.soundEnabled";function xe(){try{const g=localStorage.getItem(At);return g===null?!0:g==="1"}catch{return!0}}function we(g){try{localStorage.setItem(At,g?"1":"0")}catch{}}function be(g,t){const e=g.parentElement;if(!e)return;const s=document.createElement("div");s.id="howto-overlay",s.setAttribute("role","dialog"),s.setAttribute("aria-modal","true"),s.style.position="absolute",s.style.inset="0",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.background="rgba(0,0,0,0.82)",s.style.zIndex="12";const i=document.createElement("div");i.style.width="min(880px, 92vw)",i.style.maxHeight="86vh",i.style.overflow="auto",i.style.padding="18px 22px",i.style.border="1px solid #3b4a66",i.style.borderRadius="10px",i.style.background="linear-gradient(145deg, #141a26, #0f1520)",i.style.boxShadow="0 12px 40px rgba(0,0,0,0.6)",i.style.color="#e6eef8",i.style.fontFamily="Courier New, monospace";const o=document.createElement("div");o.style.display="grid",o.style.gridTemplateColumns="1fr",o.style.alignItems="center",o.style.marginBottom="10px";const n=document.createElement("div");n.textContent="How to Play",n.style.fontSize="18px",n.style.fontWeight="bold",n.style.color="#9ecbff",n.style.justifySelf="start",o.appendChild(n);const a=C=>{const w=document.createElement("div"),R=document.createElement("div");return R.textContent=C,R.style.marginTop="10px",R.style.marginBottom="6px",R.style.fontSize="14px",R.style.color="#a9c7ff",w.appendChild(R),{root:w,head:R}},r=C=>{const w=document.createElement("span");return w.textContent=C,w.style.display="inline-block",w.style.minWidth="18px",w.style.padding="3px 7px",w.style.margin="2px 6px 2px 0",w.style.textAlign="center",w.style.border="1px solid #3e77a8",w.style.borderRadius="5px",w.style.background="linear-gradient(145deg,#1d2a3a,#162233)",w.style.color="#d7e9ff",w.style.fontSize="12px",w},l=a("Manual Controls"),c=document.createElement("div");c.style.display="grid",c.style.gridTemplateColumns="repeat(auto-fit, minmax(220px, 1fr))",c.style.gap="6px 14px";const h=(C,w)=>{const R=document.createElement("div");R.appendChild(r(C));const T=document.createElement("span");return T.textContent=` ${w}`,R.appendChild(T),R};c.append(h("Space","Ignite engine"),h("B","Cut engine"),h("T","Full throttle"),h("G","Zero throttle"),h("â†‘ / â†“","Throttle Â±10%"),h("â† / â†’","Turn left/right"),h("S","Stage"),h("Scroll","Zoom camera"),h("P","Pause")),l.root.appendChild(c);const u=a("Game Speed"),d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.gap="10px";const y=document.createElement("span");y.textContent="Adjust with:";const m=C=>{const w=document.createElement("span");return w.textContent=C,w.style.padding="3px 8px",w.style.border="1px solid #555",w.style.borderRadius="4px",w.style.background="linear-gradient(145deg,#2d2d2d,#202020)",w.style.color="#ddd",w.style.fontSize="11px",w};d.append(y,m("1x"),m("3x"),m("10x"),m("50x"));const f=document.createElement("div");f.textContent="Higher speeds unlock with altitude; a message will guide you.",f.style.opacity="0.9",f.style.fontSize="12px",f.style.marginTop="4px",u.root.append(d,f);const b=a("Auto Pilot"),S=document.createElement("div");S.textContent="Run small scripts to automate launch. Example:",S.style.marginBottom="6px";const M=document.createElement("pre");M.textContent=["ignite","hold up","throttle 1","wait until altitude 6000","pitch east 15","wait until stage empty","cut"].join(`
`),M.style.background="#0e1724",M.style.border="1px solid #24314a",M.style.borderRadius="6px",M.style.padding="10px 12px",M.style.color="#c8e1ff",M.style.fontSize="12px",M.style.overflowX="auto",b.root.append(S,M);const x=document.createElement("div");x.style.display="flex",x.style.justifyContent="center",x.style.marginTop="12px";const v=document.createElement("button");v.textContent="Back",v.style.background="#7a1f1f",v.style.border="1px solid #c62828",v.style.color="#ffeaea",v.style.padding="6px 10px",v.style.borderRadius="6px",v.style.cursor="pointer",v.onclick=()=>s.remove(),x.appendChild(v),i.append(o,l.root,u.root,b.root,x),s.appendChild(i),e.appendChild(s);const A=C=>{C.key==="Escape"&&(C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation?.(),s.remove())};document.addEventListener("keydown",A,{capture:!0})}function Se(g,t){const e=g.parentElement;if(!e)return;const s=document.createElement("div");s.id="intro-overlay",s.setAttribute("role","dialog"),s.setAttribute("aria-modal","true"),s.style.position="absolute",s.style.inset="0",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="center",s.style.background="rgba(0,0,0,0.8)",s.style.color="#e8e8e8",s.style.zIndex="10";const i=document.createElement("div");i.style.minWidth="320px",i.style.padding="20px 24px",i.style.border="1px solid #444",i.style.borderRadius="8px",i.style.background="rgba(20,20,30,0.9)",i.style.boxShadow="0 6px 24px rgba(0,0,0,0.5)";const o=document.createElement("div");o.textContent="Mini Orbital Launch",o.style.fontSize="20px",o.style.fontWeight="bold",o.style.marginBottom="12px",o.style.textAlign="center",i.appendChild(o);const n=m=>{const f=document.createElement("button");return f.textContent=m,f.style.display="block",f.style.width="100%",f.style.margin="8px 0",f.style.padding="10px 12px",f.style.fontFamily="Courier New, monospace",f.style.fontSize="14px",f.style.background="linear-gradient(145deg,#404040,#303030)",f.style.color="#ddd",f.style.border="1px solid #555",f.style.borderRadius="6px",f.style.cursor="pointer",f.onmouseenter=()=>{f.style.background="linear-gradient(145deg,#505050,#404040)"},f.onmouseleave=()=>{f.style.background="linear-gradient(145deg,#404040,#303030)"},f},a=n("New Game");a.setAttribute("aria-label","Start a new game"),a.onclick=async()=>{s.remove(),await t();try{localStorage.setItem("hasSave","1")}catch{}};const r=n("How to Play");r.setAttribute("aria-label","How to play"),r.onclick=()=>{be(g)};const l=document.createElement("div");l.style.marginTop="6px";const c=document.createElement("label");c.style.display="flex",c.style.alignItems="center",c.style.gap="8px",c.style.fontSize="13px";const h=document.createElement("input");h.type="checkbox",h.checked=xe(),h.onchange=()=>we(h.checked);const u=document.createElement("span");u.textContent="Sound enabled",c.appendChild(h),c.appendChild(u);const d=document.createElement("div");d.textContent="Options",d.style.marginTop="12px",d.style.marginBottom="4px",d.style.color="#9ecbff",d.style.fontSize="13px",l.appendChild(d),l.appendChild(c),i.appendChild(a),i.appendChild(r),i.appendChild(l),s.appendChild(i),e.appendChild(s);const y=m=>{if(m.key!=="Escape")return;const f=document.getElementById("readme-overlay"),b=document.getElementById("lexicon-overlay"),S=document.getElementById("howto-overlay"),M=x=>!!x&&x.style.display==="flex";M(f)||M(b)||S||s.remove()};document.addEventListener("keydown",y)}function Me(){const g=document.querySelector(".monitor-container");if(!g)return;const t=document.createElement("button");t.textContent="READ ME",t.setAttribute("aria-label","Open readme overlay"),t.style.position="absolute",t.style.left="60px",t.style.bottom="6px",t.style.transform="translateY(100%)",t.style.padding="6px 10px",t.style.fontFamily="Courier New, monospace",t.style.fontSize="12px",t.style.borderRadius="12px",t.style.border="1px solid #555",t.style.background="linear-gradient(145deg, #404040, #303030)",t.style.color="#ddd",t.style.cursor="pointer",t.style.zIndex="5",t.onmouseenter=()=>{t.style.background="linear-gradient(145deg,#505050,#404040)"},t.onmouseleave=()=>{t.style.background="linear-gradient(145deg,#404040,#303030)"},g.appendChild(t);const e=document.createElement("div");e.id="readme-overlay",e.style.position="absolute",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.style.inset="0",e.style.background="rgba(0,0,0,0.55)",e.style.display="none",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="30";const s=document.createElement("div");s.style.width="min(820px, 92%)",s.style.maxHeight="80%",s.style.overflowY="auto",s.style.background="linear-gradient(180deg, #131722 0%, #0f1220 100%)",s.style.border="1px solid #556",s.style.borderRadius="14px",s.style.boxShadow="0 10px 30px rgba(0,0,0,0.6)",s.style.color="#e6e9f2",s.style.padding="18px 20px 14px",s.style.position="relative";const i=document.createElement("button");i.textContent="Ã—",i.setAttribute("aria-label","Close overlay"),i.title="Close",i.style.position="absolute",i.style.top="10px",i.style.right="10px",i.style.width="26px",i.style.height="26px",i.style.borderRadius="50%",i.style.border="none",i.style.background="#ff3b30",i.style.color="#fff",i.style.fontSize="18px",i.style.cursor="pointer",i.onclick=()=>{e.style.display="none"},s.appendChild(i);const o=document.createElement("div");o.style.fontSize="14px",o.style.lineHeight="1.55",o.style.marginBottom="10px",o.style.whiteSpace="pre-wrap",o.textContent=`Welcome to Mini Orbital Launch ðŸš€
This is a tiny 2D rocket sandbox. 
Command Console :
Type simple lines and press Run. Use â€œthenâ€, new lines, or spaces between steps.
Examples:
ignite throttle 1 until apoapsis = 100000 throttle 0 wait until apoapsis hold prograde ignite throttle 1 until periapsis = 110000 cut
You can also use:
pitch east 10 (aim nose a bit east), wait 5,
wait until altitude 15000, wait until stage empty,
hold prograde or hold retrograde, throttle 0.6, cut.
Tips:
â€¢ Pitch gently east (5Â°â€“15Â°), then let gravity + thrust bend the path.
â€¢ Coast to apoapsis, then circularize to raise periapsis. Aim â‰ˆ 110 km.
â€¢ Keep an eye on staging !`,s.appendChild(o);const n=document.createElement("button");n.textContent="Close",n.style.marginTop="6px",n.style.padding="8px 12px",n.style.border="1px solid #556",n.style.background="#1a2236",n.style.color="#e6e9f2",n.style.borderRadius="8px",n.style.cursor="pointer",n.onclick=()=>{e.style.display="none"},s.appendChild(n),e.appendChild(s),g.appendChild(e),t.onclick=()=>{e.style.display="flex"};const a=document.createElement("button");a.textContent="LEXICON",a.setAttribute("aria-label","Open lexicon overlay"),a.style.position="absolute",a.style.left="160px",a.style.bottom="6px",a.style.transform="translateY(100%)",a.style.padding="6px 10px",a.style.fontFamily="Courier New, monospace",a.style.fontSize="12px",a.style.borderRadius="12px",a.style.border="1px solid #555",a.style.background="linear-gradient(145deg, #404040, #303030)",a.style.color="#ddd",a.style.cursor="pointer",a.style.zIndex="5",a.onmouseenter=()=>{a.style.background="linear-gradient(145deg,#505050,#404040)"},a.onmouseleave=()=>{a.style.background="linear-gradient(145deg,#404040,#303030)"},g.appendChild(a);const r=document.createElement("div");r.id="lexicon-overlay",r.style.position="absolute",r.style.inset="0",r.style.background="rgba(0,0,0,0.5)",r.style.display="none",r.style.alignItems="center",r.style.justifyContent="center",r.style.zIndex="31";const l=document.createElement("div");l.style.width="min(700px, 92%)",l.style.maxHeight="78%",l.style.overflowY="auto",l.style.background="linear-gradient(180deg, #131722 0%, #0f1220 100%)",l.style.border="1px solid #556",l.style.borderRadius="14px",l.style.boxShadow="0 10px 30px rgba(0,0,0,0.6)",l.style.color="#e6e9f2",l.style.padding="18px 20px 14px",l.style.position="relative";const c=document.createElement("button");c.textContent="Ã—",c.setAttribute("aria-label","Close lexicon"),c.title="Close",c.style.position="absolute",c.style.top="10px",c.style.right="10px",c.style.width="26px",c.style.height="26px",c.style.borderRadius="50%",c.style.border="none",c.style.background="#ff3b30",c.style.color="#fff",c.style.fontSize="18px",c.style.cursor="pointer",c.onclick=()=>{r.style.display="none"},l.appendChild(c);const h=document.createElement("div");h.textContent="Lexicon â€” Simple words",h.style.fontSize="18px",h.style.fontWeight="bold",h.style.marginBottom="8px",l.appendChild(h);const u=document.createElement("div");u.style.whiteSpace="pre-wrap",u.style.lineHeight="1.6",u.textContent=`TWR (Thrustâ€‘toâ€‘Weight Ratio):
How strong your engines push compared to your weight. TWR > 1 means you can lift off.

Apoapsis (Ap):
The highest point of your orbit. If you coast to Ap and burn prograde, the other side rises.

Periapsis (Pe):
The lowest point of your orbit. If you burn prograde at Pe, the opposite side rises.

Prograde / Retrograde:
Prograde = the direction you are moving. Retrograde = the opposite direction.
Holding prograde during ascent creates a gravity turn; holding retrograde slows you down.

Circularize:
Burn at Ap (or Pe) to raise the opposite side until both match â€” that makes a circle.

Deltaâ€‘V (Î”v):
Your "fuel budget" in m/s â€” how much you can change your speed. Fighting gravity or air resistance costs you extra.

ISP (Specific Impulse):
How efficient an engine is. Higher ISP means more push per unit of fuel (better efficiency).

Throttle:
How hard the engine pushes right now (0% to 100%). Lower throttle saves fuel but burns longer.`,l.appendChild(u);const d=document.createElement("button");d.textContent="Close",d.style.marginTop="6px",d.style.padding="8px 12px",d.style.border="1px solid #556",d.style.background="#1a2236",d.style.color="#e6e9f2",d.style.borderRadius="8px",d.style.cursor="pointer",d.onclick=()=>{r.style.display="none"},l.appendChild(d),r.appendChild(l),g.appendChild(r),a.onclick=()=>{r.style.display="flex"};const y=m=>{const f=e.style.display==="flex",b=r.style.display==="flex";m.key==="Escape"&&(f||b)&&(m.preventDefault(),m.stopPropagation(),m.stopImmediatePropagation?.(),e.style.display="none",r.style.display="none")};document.addEventListener("keydown",y,{capture:!0})}function ve(){document.addEventListener("game-speed-change",g=>{const t=g.detail?.speed;if(!t)return;const e=document.querySelectorAll(".speed-btn");for(const s of Array.from(e)){const i=s;Number.parseInt(i.dataset.speed||"1")===t?i.classList.add("active"):i.classList.remove("active")}})}const tt=document.getElementById("gameCanvas");if(!tt)throw new Error("Canvas element not found");async function ke(){try{const g=new me(tt);await g.initialize(),g.start(),ye(g);const t=tt.parentElement;return t&&"ResizeObserver"in window&&new ResizeObserver(()=>window.dispatchEvent(new Event("resize"))).observe(t),g}catch(g){return console.error("Failed to start game:",g),null}}Se(tt,ke);Me();ve();
//# sourceMappingURL=index-DS902wvm.js.map
